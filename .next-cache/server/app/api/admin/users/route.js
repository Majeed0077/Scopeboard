"use strict";(()=>{var e={};e.id=2628,e.ids=[2628],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},36047:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>Z,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>S,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{GET:()=>y,POST:()=>I});var a=r(73278),i=r(45002),o=r(54877),s=r(71309),l=r(48948),d=r(63253),p=r(46993),c=r(79551),u=r(73275),m=r(88483),w=r(13634);async function y(e){let t;try{t=await (0,u.oT)(e)}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}await (0,l.C)();let r=await d.T.find({workspaceId:t.workspaceId}).sort({createdAt:-1}).lean(),n=await p.N.find({workspaceId:t.workspaceId,isActive:!0}).lean(),a=new Set(r.map(e=>String(e._id))),i=n.map(e=>String(e.userId)).filter(e=>!a.has(e)),o=i.length>0?await d.T.find({_id:{$in:i},isActive:!0}).lean():[],c=new Map(n.map(e=>[String(e.userId),e])),m=[...r,...o].map(e=>{let r=e.workspaceId===t.workspaceId,n=c.get(String(e._id));return{id:String(e._id),name:e.name,email:e.email,role:r?"owner"===e.role?"Owner":"Editor":n?.role==="owner"?"Owner":"Editor",isActive:r?!!e.isActive:!!(n?.isActive&&e.isActive),isDirect:r,isSelf:String(e._id)===t.userId,createdAt:e.createdAt,updatedAt:e.updatedAt}}).sort((e,t)=>new Date(String(t.createdAt??0)).getTime()-new Date(String(e.createdAt??0)).getTime());return s.NextResponse.json({success:!0,data:m})}async function I(e){let t;try{if(t=await (0,u.oT)(e),"owner"!==t.role)return s.NextResponse.json({success:!1,error:"Forbidden"},{status:403})}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}let r=await e.json(),n=m.cM.safeParse(r);if(!n.success)return s.NextResponse.json({success:!1,error:n.error.flatten()},{status:400});await (0,l.C)();let a=n.data.email.toLowerCase(),i=await d.T.findOne({email:a}).lean();if(i)return i.workspaceId===t.workspaceId?s.NextResponse.json({success:!1,error:"Email already exists."},{status:409}):(await p.N.updateOne({userId:String(i._id),workspaceId:t.workspaceId},{$set:{role:"Owner"===n.data.role?"owner":"editor",isActive:!0,invitedById:t.userId}},{upsert:!0}),await c.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:t.workspaceId,createdAt:new Date().toISOString(),actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"Existing user added to workspace",entityType:"user",entityId:String(i._id),meta:i.email}),s.NextResponse.json({success:!0,data:{id:String(i._id),name:i.name,email:i.email,role:n.data.role,isActive:!0,isDirect:!1,isSelf:String(i._id)===t.userId,createdAt:i.createdAt,updatedAt:i.updatedAt}}));let o=await (0,w.c)(n.data.password),y=await d.T.create({email:a,name:n.data.name,role:n.data.role,workspaceId:t.workspaceId,passwordHash:o,isActive:!0});return await c.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:t.workspaceId,createdAt:new Date().toISOString(),actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"User created",entityType:"user",entityId:String(y._id),meta:y.email}),s.NextResponse.json({success:!0,data:{id:String(y._id),name:y.name,email:y.email,role:y.role,isActive:y.isActive,isDirect:!0,isSelf:String(y._id)===t.userId,createdAt:y.createdAt,updatedAt:y.updatedAt}})}let g=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\admin\\users\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:f,serverHooks:S}=g,k="/api/admin/users/route";function Z(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:f})}},73275:(e,t,r)=>{r.d(t,{KF:()=>A,MH:()=>f,XC:()=>Z,Zk:()=>v,hg:()=>k,kt:()=>I,oT:()=>_,ts:()=>S,v6:()=>g});var n=r(52845),a=r(67370),i=r(32914),o=r(63253),s=r(82279),l=r(46993),d=r(48948);let p="vaultflow_session",c="vaultflow_workspace";function u(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function m(e){return"owner"===e.toLowerCase()?"owner":"editor"}function w(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function y(e,t,r){await (0,d.C)();let n=await o.T.findById(e).lean();if(!n||!n.isActive)return null;let a=r||t||n.workspaceId;if(a===n.workspaceId)return{workspaceId:a,role:m(n.role),email:n.email,name:n.name};let i=await l.N.findOne({userId:e,workspaceId:a,isActive:!0}).lean();return i?{workspaceId:a,role:"owner"===i.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:m(n.role),email:n.email,name:n.name}}async function I(e){let t=Math.floor(Date.now()/1e3);return new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(u())}async function g(e){try{let t=e.headers.get("cookie"),r=w(t,p);if(!r)return null;let{payload:n}=await (0,i._)(r,u()),a="string"==typeof n.userId?n.userId:"",o="string"==typeof n.workspaceId?n.workspaceId:"",s=w(t,c);if(!a)return null;let l=await y(a,o,s);if(!l)return null;return{userId:a,workspaceId:l.workspaceId,role:l.role,email:l.email,name:l.name}}catch{return null}}async function _(e){let t=await g(e);if(!t)throw Error("Unauthorized");return t}async function f(e,t){let r=await _(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function S(){let e=(0,n.cookies)(),t=e.get(p)?.value;if(!t)return null;try{let{payload:r}=await (0,i._)(t,u()),n="string"==typeof r.userId?r.userId:"",a="string"==typeof r.workspaceId?r.workspaceId:"",s=e.get(c)?.value??"";if(!n)return null;let l=await y(n,a,s);if(!l)return null;let d=await o.T.findById(n).lean();if(!d||!d.isActive)return null;return{id:String(d._id),workspaceId:l.workspaceId,name:d.name,email:d.email,role:l.role,avatarUrl:d.avatarUrl??""}}catch{return null}}async function k(){let e=await S();if(!e)return[];await (0,d.C)();let t=await o.T.findById(e.id).lean();if(!t)return[];let r=await l.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),a=await s.u.find({_id:{$in:n},isActive:!0}).lean();if(!a.some(e=>String(e._id)===String(t.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&a.push(e)}return n.map(n=>{let i=a.find(e=>String(e._id)===n),o=r.find(e=>String(e.workspaceId)===n),s=n===String(t.workspaceId)?"owner":o?.role==="owner"?"owner":"editor";return{id:n,name:i?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:i?.logoUrl??"",role:s,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function Z(){let e=await S();return e?.role??null}async function v(){return p}async function A(){return c}},48948:(e,t,r)=>{r.d(t,{C:()=>s});var n=r(11185),a=r.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("MONGODB_URI is not defined");let o=global.mongoose??{conn:null,promise:null};async function s(){return o.conn||(o.promise||(o.promise=a().connect(i).then(e=>e)),o.conn=await o.promise,global.mongoose=o),o.conn}},79551:(e,t,r)=>{r.d(t,{u:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),o=a().models.Audit||a().model("Audit",i)},63253:(e,t,r)=>{r.d(t,{T:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});i.index({email:1},{unique:!0}),i.index({workspaceId:1,role:1}),i.index({workspaceId:1,isActive:1});let o=a().models.User||a().model("User",i)},82279:(e,t,r)=>{r.d(t,{u:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),o=a().models.Workspace||a().model("Workspace",i)},46993:(e,t,r)=>{r.d(t,{N:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});i.index({workspaceId:1,userId:1},{unique:!0}),i.index({userId:1,isActive:1});let o=a().models.WorkspaceMembership||a().model("WorkspaceMembership",i)},13634:(e,t,r)=>{r.d(t,{G:()=>o,c:()=>i});var n=r(63506),a=r.n(n);async function i(e){let t=await a().genSalt(10);return a().hash(e,t)}async function o(e,t){return a().compare(e,t)}},88483:(e,t,r)=>{r.d(t,{CB:()=>s,CP:()=>I,IK:()=>m,Im:()=>l,It:()=>w,JE:()=>d,K9:()=>c,Ov:()=>u,Qm:()=>i,Qp:()=>_,VJ:()=>a,X5:()=>f,cM:()=>y,jt:()=>p,nf:()=>g,rP:()=>o});var n=r(69977);let a=n.Ryn({name:n.Z_8().min(1),email:n.Z_8().email().optional().or(n.i0J("")),phone:n.Z_8().optional().or(n.i0J("")),company:n.Z_8().optional().or(n.i0J("")),source:n.Z_8().optional(),sourceLabel:n.Z_8().optional(),stage:n.Z_8().optional(),nextFollowUpAt:n.Z_8().optional(),followUpCadence:n.KmV(["none","weekly","monthly","custom"]).optional(),followUpIntervalDays:n.Rxh().optional(),tags:n.IXX(n.Z_8()).optional(),notes:n.IXX(n.Ryn({id:n.Z_8(),body:n.Z_8(),createdAt:n.Z_8()})).optional(),archived:n.O72().optional()}),i=a.partial(),o=n.Ryn({title:n.Z_8().min(1),name:n.Z_8().optional(),contactId:n.Z_8().min(1).optional(),clientName:n.Z_8().optional(),status:n.Z_8().optional(),pipelineStage:n.Z_8().optional(),notes:n.Z_8().optional(),attachments:n.IXX(n.Ryn({id:n.Z_8().optional(),name:n.Z_8().min(1),url:n.Z_8().min(1),type:n.Z_8().optional().default(""),size:n.Rxh().nonnegative()})).optional(),startDate:n.Z_8().optional(),dueDate:n.Z_8().optional(),budgetAmount:n.Rxh().optional(),currency:n.Z_8().optional(),links:n.IXX(n.Z_8().url()).optional(),archived:n.O72().optional()}),s=o.partial().extend({removeAttachmentUrls:n.IXX(n.Z_8().min(1)).optional()}),l=n.Ryn({invoiceNo:n.Z_8().min(1),projectId:n.Z_8().min(1),contactId:n.Z_8().min(1),status:n.Z_8().optional(),issueDate:n.Z_8().optional(),dueDate:n.Z_8().optional(),paidDate:n.Z_8().optional(),amount:n.Rxh().optional(),currency:n.Z_8().optional(),lineItems:n.IXX(n.Ryn({title:n.Z_8(),qty:n.Rxh(),rate:n.Rxh()})).optional(),payments:n.IXX(n.Ryn({amount:n.Rxh(),method:n.Z_8(),paidAt:n.Z_8(),note:n.Z_8().optional()})).optional(),archived:n.O72().optional()}),d=l.partial(),p=n.Ryn({entityType:n.KmV(["contact","project","invoice","milestone"]),entityId:n.Z_8().min(1),action:n.Z_8().min(1),message:n.Z_8().optional(),userRole:n.Z_8().optional()}),c=p.partial(),u=n.Ryn({projectId:n.Z_8().min(1),title:n.Z_8().min(1),status:n.Z_8().optional(),dueDate:n.Z_8().optional(),amount:n.Rxh().optional(),currency:n.Z_8().optional(),order:n.Rxh().optional()}),m=u.partial(),w=n.Ryn({action:n.Z_8().min(1),entityType:n.Z_8().optional(),entityId:n.Z_8().optional(),meta:n.Z_8().optional()}),y=n.Ryn({name:n.Z_8().min(1),email:n.Z_8().email(),role:n.KmV(["Owner","Editor"]),password:n.Z_8().min(8)}),I=n.Ryn({name:n.Z_8().min(1).optional(),role:n.KmV(["Owner","Editor"]).optional(),isActive:n.O72().optional(),password:n.Z_8().min(8).optional()}),g=n.Ryn({orgName:n.Z_8().min(1),timezone:n.Z_8().min(1),logoUrl:n.Z_8().optional()}),_=n.Ryn({name:n.Z_8().min(1).optional(),avatarUrl:n.Z_8().min(1).optional().or(n.i0J(""))}),f=n.Ryn({email:n.Z_8().email(),name:n.Z_8().optional().or(n.i0J("")),role:n.KmV(["Owner","Editor"])});n.Ryn({status:n.KmV(["revoked"]).optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833,9977,3506],()=>r(36047));module.exports=n})();