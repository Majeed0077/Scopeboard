"use strict";(()=>{var e={};e.id=1317,e.ids=[1317],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},36735:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>Z,requestAsyncStorage:()=>g,routeModule:()=>_,serverHooks:()=>S,staticGenerationAsyncStorage:()=>k});var n={};r.r(n),r.d(n,{DELETE:()=>f,PATCH:()=>I});var a=r(73278),o=r(45002),i=r(54877),s=r(71309),d=r(48948),l=r(63253),c=r(46993),p=r(79551),u=r(73275),m=r(88483),w=r(13634);async function y(e){let t=await (0,u.oT)(e);if("owner"!==t.role)throw Error("Forbidden");return t}async function I(e,{params:t}){let r;try{r=await y(e)}catch(t){let e=String(t).includes("Forbidden")?403:401;return s.NextResponse.json({success:!1,error:403===e?"Forbidden":"Unauthorized"},{status:e})}let n=await e.json(),a=m.CP.safeParse(n);if(!a.success)return s.NextResponse.json({success:!1,error:a.error.flatten()},{status:400});await (0,d.C)();let o=await l.T.findById(t.id).lean();if(!o)return s.NextResponse.json({success:!1,error:"Not found"},{status:404});if(o.workspaceId===r.workspaceId){let e={...a.data};a.data.password&&(e.passwordHash=await (0,w.c)(a.data.password),delete e.password);let n=await l.T.findOneAndUpdate({_id:t.id,workspaceId:r.workspaceId},e,{new:!0}).lean();return n?(await p.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:r.workspaceId,createdAt:new Date().toISOString(),actorId:r.userId,actorRole:r.role,actorEmail:r.email,action:"User updated",entityType:"user",entityId:String(n._id),meta:n.email}),s.NextResponse.json({success:!0,data:{id:String(n._id),name:n.name,email:n.email,role:"owner"===n.role?"Owner":"Editor",isActive:n.isActive,isDirect:!0,isSelf:String(n._id)===r.userId,createdAt:n.createdAt,updatedAt:n.updatedAt}})):s.NextResponse.json({success:!1,error:"Not found"},{status:404})}if(!await c.N.findOne({userId:String(o._id),workspaceId:r.workspaceId}).lean())return s.NextResponse.json({success:!1,error:"Not found"},{status:404});let i={};if(a.data.role&&(i.role="Owner"===a.data.role?"owner":"editor"),"boolean"==typeof a.data.isActive&&(i.isActive=a.data.isActive),0===Object.keys(i).length)return s.NextResponse.json({success:!1,error:"Only role/status can be changed for cross-workspace members."},{status:400});let u=await c.N.findOneAndUpdate({userId:String(o._id),workspaceId:r.workspaceId},{$set:i},{new:!0}).lean();return await p.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:r.workspaceId,createdAt:new Date().toISOString(),actorId:r.userId,actorRole:r.role,actorEmail:r.email,action:"Workspace member updated",entityType:"user",entityId:String(o._id),meta:o.email}),s.NextResponse.json({success:!0,data:{id:String(o._id),name:o.name,email:o.email,role:u?.role==="owner"?"Owner":(u?.role,"Editor"),isActive:!!(u?.isActive&&o.isActive),isDirect:!1,isSelf:String(o._id)===r.userId,createdAt:o.createdAt,updatedAt:o.updatedAt}})}async function f(e,{params:t}){let r;try{r=await y(e)}catch(t){let e=String(t).includes("Forbidden")?403:401;return s.NextResponse.json({success:!1,error:403===e?"Forbidden":"Unauthorized"},{status:e})}await (0,d.C)();let n=await l.T.findById(t.id).lean();if(!n)return s.NextResponse.json({success:!1,error:"User not found."},{status:404});if(String(n._id)===r.userId)return s.NextResponse.json({success:!1,error:"You cannot remove yourself from this team."},{status:400});if(n.workspaceId===r.workspaceId)return s.NextResponse.json({success:!1,error:"This user belongs to this workspace directly and cannot be removed from membership."},{status:400});let a=await c.N.findOne({userId:String(n._id),workspaceId:r.workspaceId,isActive:!0}).lean();return a?"owner"===a.role&&await c.N.countDocuments({workspaceId:r.workspaceId,isActive:!0,role:"owner"})<=1?s.NextResponse.json({success:!1,error:"At least one owner must remain in this team."},{status:400}):(await c.N.deleteOne({userId:String(n._id),workspaceId:r.workspaceId}),await p.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:r.workspaceId,createdAt:new Date().toISOString(),actorId:r.userId,actorRole:r.role,actorEmail:r.email,action:"Workspace member removed",entityType:"user",entityId:String(n._id),meta:n.email}),s.NextResponse.json({success:!0,data:{id:String(n._id)}})):s.NextResponse.json({success:!1,error:"Member not found in this team."},{status:404})}let _=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/users/[id]/route",pathname:"/api/admin/users/[id]",filename:"route",bundlePath:"app/api/admin/users/[id]/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\admin\\users\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:k,serverHooks:S}=_,v="/api/admin/users/[id]/route";function Z(){return(0,i.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:k})}},73275:(e,t,r)=>{r.d(t,{KF:()=>h,MH:()=>g,XC:()=>v,Zk:()=>Z,hg:()=>S,kt:()=>I,oT:()=>_,ts:()=>k,v6:()=>f});var n=r(52845),a=r(67370),o=r(32914),i=r(63253),s=r(82279),d=r(46993),l=r(48948);let c="vaultflow_session",p="vaultflow_workspace";function u(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function m(e){return"owner"===e.toLowerCase()?"owner":"editor"}function w(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function y(e,t,r){await (0,l.C)();let n=await i.T.findById(e).lean();if(!n||!n.isActive)return null;let a=r||t||n.workspaceId;if(a===n.workspaceId)return{workspaceId:a,role:m(n.role),email:n.email,name:n.name};let o=await d.N.findOne({userId:e,workspaceId:a,isActive:!0}).lean();return o?{workspaceId:a,role:"owner"===o.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:m(n.role),email:n.email,name:n.name}}async function I(e){let t=Math.floor(Date.now()/1e3);return new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(u())}async function f(e){try{let t=e.headers.get("cookie"),r=w(t,c);if(!r)return null;let{payload:n}=await (0,o._)(r,u()),a="string"==typeof n.userId?n.userId:"",i="string"==typeof n.workspaceId?n.workspaceId:"",s=w(t,p);if(!a)return null;let d=await y(a,i,s);if(!d)return null;return{userId:a,workspaceId:d.workspaceId,role:d.role,email:d.email,name:d.name}}catch{return null}}async function _(e){let t=await f(e);if(!t)throw Error("Unauthorized");return t}async function g(e,t){let r=await _(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function k(){let e=(0,n.cookies)(),t=e.get(c)?.value;if(!t)return null;try{let{payload:r}=await (0,o._)(t,u()),n="string"==typeof r.userId?r.userId:"",a="string"==typeof r.workspaceId?r.workspaceId:"",s=e.get(p)?.value??"";if(!n)return null;let d=await y(n,a,s);if(!d)return null;let l=await i.T.findById(n).lean();if(!l||!l.isActive)return null;return{id:String(l._id),workspaceId:d.workspaceId,name:l.name,email:l.email,role:d.role,avatarUrl:l.avatarUrl??""}}catch{return null}}async function S(){let e=await k();if(!e)return[];await (0,l.C)();let t=await i.T.findById(e.id).lean();if(!t)return[];let r=await d.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),a=await s.u.find({_id:{$in:n},isActive:!0}).lean();if(!a.some(e=>String(e._id)===String(t.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&a.push(e)}return n.map(n=>{let o=a.find(e=>String(e._id)===n),i=r.find(e=>String(e.workspaceId)===n),s=n===String(t.workspaceId)?"owner":i?.role==="owner"?"owner":"editor";return{id:n,name:o?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:o?.logoUrl??"",role:s,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function v(){let e=await k();return e?.role??null}async function Z(){return c}async function h(){return p}},48948:(e,t,r)=>{r.d(t,{C:()=>s});var n=r(11185),a=r.n(n);let o=process.env.MONGODB_URI;if(!o)throw Error("MONGODB_URI is not defined");let i=global.mongoose??{conn:null,promise:null};async function s(){return i.conn||(i.promise||(i.promise=a().connect(o).then(e=>e)),i.conn=await i.promise,global.mongoose=i),i.conn}},79551:(e,t,r)=>{r.d(t,{u:()=>i});var n=r(11185),a=r.n(n);let o=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),i=a().models.Audit||a().model("Audit",o)},63253:(e,t,r)=>{r.d(t,{T:()=>i});var n=r(11185),a=r.n(n);let o=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});o.index({email:1},{unique:!0}),o.index({workspaceId:1,role:1}),o.index({workspaceId:1,isActive:1});let i=a().models.User||a().model("User",o)},82279:(e,t,r)=>{r.d(t,{u:()=>i});var n=r(11185),a=r.n(n);let o=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),i=a().models.Workspace||a().model("Workspace",o)},46993:(e,t,r)=>{r.d(t,{N:()=>i});var n=r(11185),a=r.n(n);let o=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});o.index({workspaceId:1,userId:1},{unique:!0}),o.index({userId:1,isActive:1});let i=a().models.WorkspaceMembership||a().model("WorkspaceMembership",o)},13634:(e,t,r)=>{r.d(t,{G:()=>i,c:()=>o});var n=r(63506),a=r.n(n);async function o(e){let t=await a().genSalt(10);return a().hash(e,t)}async function i(e,t){return a().compare(e,t)}},88483:(e,t,r)=>{r.d(t,{CB:()=>s,CP:()=>I,IK:()=>m,Im:()=>d,It:()=>w,JE:()=>l,K9:()=>p,Ov:()=>u,Qm:()=>o,Qp:()=>_,VJ:()=>a,X5:()=>g,cM:()=>y,jt:()=>c,nf:()=>f,rP:()=>i});var n=r(69977);let a=n.Ryn({name:n.Z_8().min(1),email:n.Z_8().email().optional().or(n.i0J("")),phone:n.Z_8().optional().or(n.i0J("")),company:n.Z_8().optional().or(n.i0J("")),source:n.Z_8().optional(),sourceLabel:n.Z_8().optional(),stage:n.Z_8().optional(),nextFollowUpAt:n.Z_8().optional(),followUpCadence:n.KmV(["none","weekly","monthly","custom"]).optional(),followUpIntervalDays:n.Rxh().optional(),tags:n.IXX(n.Z_8()).optional(),notes:n.IXX(n.Ryn({id:n.Z_8(),body:n.Z_8(),createdAt:n.Z_8()})).optional(),archived:n.O72().optional()}),o=a.partial(),i=n.Ryn({title:n.Z_8().min(1),name:n.Z_8().optional(),contactId:n.Z_8().min(1).optional(),clientName:n.Z_8().optional(),status:n.Z_8().optional(),pipelineStage:n.Z_8().optional(),notes:n.Z_8().optional(),attachments:n.IXX(n.Ryn({id:n.Z_8().optional(),name:n.Z_8().min(1),url:n.Z_8().min(1),type:n.Z_8().optional().default(""),size:n.Rxh().nonnegative()})).optional(),startDate:n.Z_8().optional(),dueDate:n.Z_8().optional(),budgetAmount:n.Rxh().optional(),currency:n.Z_8().optional(),links:n.IXX(n.Z_8().url()).optional(),archived:n.O72().optional()}),s=i.partial().extend({removeAttachmentUrls:n.IXX(n.Z_8().min(1)).optional()}),d=n.Ryn({invoiceNo:n.Z_8().min(1),projectId:n.Z_8().min(1),contactId:n.Z_8().min(1),status:n.Z_8().optional(),issueDate:n.Z_8().optional(),dueDate:n.Z_8().optional(),paidDate:n.Z_8().optional(),amount:n.Rxh().optional(),currency:n.Z_8().optional(),lineItems:n.IXX(n.Ryn({title:n.Z_8(),qty:n.Rxh(),rate:n.Rxh()})).optional(),payments:n.IXX(n.Ryn({amount:n.Rxh(),method:n.Z_8(),paidAt:n.Z_8(),note:n.Z_8().optional()})).optional(),archived:n.O72().optional()}),l=d.partial(),c=n.Ryn({entityType:n.KmV(["contact","project","invoice","milestone"]),entityId:n.Z_8().min(1),action:n.Z_8().min(1),message:n.Z_8().optional(),userRole:n.Z_8().optional()}),p=c.partial(),u=n.Ryn({projectId:n.Z_8().min(1),title:n.Z_8().min(1),status:n.Z_8().optional(),dueDate:n.Z_8().optional(),amount:n.Rxh().optional(),currency:n.Z_8().optional(),order:n.Rxh().optional()}),m=u.partial(),w=n.Ryn({action:n.Z_8().min(1),entityType:n.Z_8().optional(),entityId:n.Z_8().optional(),meta:n.Z_8().optional()}),y=n.Ryn({name:n.Z_8().min(1),email:n.Z_8().email(),role:n.KmV(["Owner","Editor"]),password:n.Z_8().min(8)}),I=n.Ryn({name:n.Z_8().min(1).optional(),role:n.KmV(["Owner","Editor"]).optional(),isActive:n.O72().optional(),password:n.Z_8().min(8).optional()}),f=n.Ryn({orgName:n.Z_8().min(1),timezone:n.Z_8().min(1),logoUrl:n.Z_8().optional()}),_=n.Ryn({name:n.Z_8().min(1).optional(),avatarUrl:n.Z_8().min(1).optional().or(n.i0J(""))}),g=n.Ryn({email:n.Z_8().email(),name:n.Z_8().optional().or(n.i0J("")),role:n.KmV(["Owner","Editor"])});n.Ryn({status:n.KmV(["revoked"]).optional()})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833,9977,3506],()=>r(36735));module.exports=n})();