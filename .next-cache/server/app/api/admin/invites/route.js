"use strict";(()=>{var e={};e.id=1750,e.ids=[1750],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},44551:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>A,patchFetch:()=>R,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>Z,staticGenerationAsyncStorage:()=>S});var r={};n.r(r),n.d(r,{GET:()=>_,POST:()=>k});var i=n(73278),a=n(45002),o=n(54877),s=n(71309),l=n(84770),d=n(48948),p=n(45018),c=n(63253),u=n(46993),m=n(79551),w=n(73275),y=n(88483),f=n(940);async function g(e){let t=process.env.RESEND_API_KEY,n=process.env.INVITE_FROM_EMAIL;if(!t||!n)return{sent:!1,provider:"none",error:"Email provider not configured"};try{let r=await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({from:n,to:[e.to],subject:"You are invited to Flowlane",html:function(e){let t=e.name?`Hi ${e.name},`:"Hi,",n=e.workspaceName?` for ${e.workspaceName}`:"";return`
    <div style="font-family:Arial,sans-serif;line-height:1.5;color:#111">
      <p>${t}</p>
      <p>${e.invitedByEmail} invited you as <strong>${e.role}</strong>${n}.</p>
      <p>
        <a href="${e.inviteUrl}" style="display:inline-block;padding:10px 14px;border-radius:8px;background:#0f172a;color:#fff;text-decoration:none;">
          Accept invite
        </a>
      </p>
      <p style="font-size:12px;color:#555;">If button does not work, open this URL:</p>
      <p style="font-size:12px;color:#555;word-break:break-all;">${e.inviteUrl}</p>
    </div>
  `}(e)})});if(!r.ok){let e=await r.text();return{sent:!1,provider:"resend",error:`Resend error: ${r.status} ${e}`}}return{sent:!0,provider:"resend"}}catch(e){return{sent:!1,provider:"resend",error:e instanceof Error?e.message:"Unknown email error"}}}function I(e){let t=e.headers.get("x-forwarded-host")??e.headers.get("host"),n=e.headers.get("x-forwarded-proto")??"http";return t?`${n}://${t}`:"http://localhost:3000"}function v(e,t){let n=new Date,r="pending"===e.status&&new Date(e.expiresAt)<n?"expired":e.status;return{id:String(e._id),email:e.email,name:e.name??"",role:e.role,status:r,invitedByEmail:e.invitedByEmail,createdAt:e.createdAt,expiresAt:e.expiresAt,acceptedAt:e.acceptedAt??null,acceptedUserId:e.acceptedUserId??null,inviteUrl:`${t}/signup?invite=${encodeURIComponent(e.token)}&email=${encodeURIComponent(e.email)}`}}async function _(e){try{let t=await (0,w.oT)(e);await (0,d.C)();let n=I(e),r=await p.q.find({workspaceId:t.workspaceId}).sort({createdAt:-1}).lean();return s.NextResponse.json({success:!0,data:r.map(e=>v(e,n))})}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}}async function k(e){let t;try{if(t=await (0,w.oT)(e),"owner"!==t.role)return s.NextResponse.json({success:!1,error:"Forbidden"},{status:403})}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}let n=(0,f.r)(e);if(!(0,f.h)({key:`invite:${t.workspaceId}:${t.userId}:${n}`,limit:30,windowMs:36e5}).ok)return s.NextResponse.json({success:!1,error:"Too many invite requests. Try again later."},{status:429});let r=await e.json(),i=y.X5.safeParse(r);if(!i.success)return s.NextResponse.json({success:!1,error:i.error.flatten()},{status:400});await (0,d.C)();let a=i.data.email.toLowerCase(),o=await c.T.findOne({email:a}).lean();if(o){let e=o.workspaceId===t.workspaceId,n=await u.N.findOne({userId:String(o._id),workspaceId:t.workspaceId,isActive:!0}).lean();if(e||n)return s.NextResponse.json({success:!1,error:"User is already part of this team."},{status:409})}await p.q.updateMany({email:a,workspaceId:t.workspaceId,status:"pending"},{$set:{status:"revoked"}});let _=(0,l.randomUUID)(),k=new Date(Date.now()+6048e5),h=await p.q.create({email:a,name:i.data.name?.trim()??"",role:i.data.role,token:_,status:"pending",invitedById:t.userId,invitedByEmail:t.email,workspaceId:t.workspaceId,expiresAt:k}),x=I(e),S=v(h.toObject(),x),Z=await g({to:S.email,name:S.name,role:S.role,inviteUrl:S.inviteUrl,invitedByEmail:t.email});return await m.u.create({_id:`aud-${(0,l.randomUUID)().slice(0,8)}`,workspaceId:t.workspaceId,createdAt:new Date().toISOString(),actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"Team invite created",entityType:"invite",entityId:String(h._id),meta:`${a} | mail:${Z.sent?"sent":"not-sent"}`}),s.NextResponse.json({success:!0,data:{...S,emailDelivery:Z}})}let h=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/invites/route",pathname:"/api/admin/invites",filename:"route",bundlePath:"app/api/admin/invites/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\admin\\invites\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:x,staticGenerationAsyncStorage:S,serverHooks:Z}=h,A="/api/admin/invites/route";function R(){return(0,o.patchFetch)({serverHooks:Z,staticGenerationAsyncStorage:S})}},73275:(e,t,n)=>{n.d(t,{KF:()=>S,MH:()=>v,XC:()=>h,Zk:()=>x,hg:()=>k,kt:()=>f,oT:()=>I,ts:()=>_,v6:()=>g});var r=n(52845),i=n(67370),a=n(32914),o=n(63253),s=n(82279),l=n(46993),d=n(48948);let p="vaultflow_session",c="vaultflow_workspace";function u(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function m(e){return"owner"===e.toLowerCase()?"owner":"editor"}function w(e,t){if(!e)return"";for(let n of e.split(";").map(e=>e.trim()))if(n.startsWith(`${t}=`))return decodeURIComponent(n.slice(`${t}=`.length));return""}async function y(e,t,n){await (0,d.C)();let r=await o.T.findById(e).lean();if(!r||!r.isActive)return null;let i=n||t||r.workspaceId;if(i===r.workspaceId)return{workspaceId:i,role:m(r.role),email:r.email,name:r.name};let a=await l.N.findOne({userId:e,workspaceId:i,isActive:!0}).lean();return a?{workspaceId:i,role:"owner"===a.role?"owner":"editor",email:r.email,name:r.name}:{workspaceId:r.workspaceId,role:m(r.role),email:r.email,name:r.name}}async function f(e){let t=Math.floor(Date.now()/1e3);return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(u())}async function g(e){try{let t=e.headers.get("cookie"),n=w(t,p);if(!n)return null;let{payload:r}=await (0,a._)(n,u()),i="string"==typeof r.userId?r.userId:"",o="string"==typeof r.workspaceId?r.workspaceId:"",s=w(t,c);if(!i)return null;let l=await y(i,o,s);if(!l)return null;return{userId:i,workspaceId:l.workspaceId,role:l.role,email:l.email,name:l.name}}catch{return null}}async function I(e){let t=await g(e);if(!t)throw Error("Unauthorized");return t}async function v(e,t){let n=await I(e),r="owner"===t.toLowerCase()?"owner":"editor";if(n.role!==r)throw Error("Forbidden");return n}async function _(){let e=(0,r.cookies)(),t=e.get(p)?.value;if(!t)return null;try{let{payload:n}=await (0,a._)(t,u()),r="string"==typeof n.userId?n.userId:"",i="string"==typeof n.workspaceId?n.workspaceId:"",s=e.get(c)?.value??"";if(!r)return null;let l=await y(r,i,s);if(!l)return null;let d=await o.T.findById(r).lean();if(!d||!d.isActive)return null;return{id:String(d._id),workspaceId:l.workspaceId,name:d.name,email:d.email,role:l.role,avatarUrl:d.avatarUrl??""}}catch{return null}}async function k(){let e=await _();if(!e)return[];await (0,d.C)();let t=await o.T.findById(e.id).lean();if(!t)return[];let n=await l.N.find({userId:e.id,isActive:!0}).lean(),r=Array.from(new Set([String(t.workspaceId),...n.map(e=>String(e.workspaceId))])),i=await s.u.find({_id:{$in:r},isActive:!0}).lean();if(!i.some(e=>String(e._id)===String(t.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&i.push(e)}return r.map(r=>{let a=i.find(e=>String(e._id)===r),o=n.find(e=>String(e.workspaceId)===r),s=r===String(t.workspaceId)?"owner":o?.role==="owner"?"owner":"editor";return{id:r,name:a?.name??(r===String(t.workspaceId)?"My Workspace":`Workspace ${r.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:s,isPersonal:r===String(t.workspaceId),isActive:r===e.workspaceId}})}async function h(){let e=await _();return e?.role??null}async function x(){return p}async function S(){return c}},48948:(e,t,n)=>{n.d(t,{C:()=>s});var r=n(11185),i=n.n(r);let a=process.env.MONGODB_URI;if(!a)throw Error("MONGODB_URI is not defined");let o=global.mongoose??{conn:null,promise:null};async function s(){return o.conn||(o.promise||(o.promise=i().connect(a).then(e=>e)),o.conn=await o.promise,global.mongoose=o),o.conn}},79551:(e,t,n)=>{n.d(t,{u:()=>o});var r=n(11185),i=n.n(r);let a=new r.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),o=i().models.Audit||i().model("Audit",a)},45018:(e,t,n)=>{n.d(t,{q:()=>o});var r=n(11185),i=n.n(r);let a=new r.Schema({email:{type:String,required:!0,lowercase:!0,index:!0},name:{type:String,default:""},role:{type:String,enum:["Owner","Editor"],required:!0},token:{type:String,required:!0,unique:!0,index:!0},status:{type:String,enum:["pending","accepted","revoked","expired"],default:"pending",index:!0},invitedById:{type:String,required:!0},invitedByEmail:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},expiresAt:{type:Date,required:!0,index:!0},acceptedAt:{type:Date},acceptedUserId:{type:String}},{timestamps:!0});a.index({workspaceId:1,email:1,status:1}),a.index({workspaceId:1,createdAt:-1});let o=i().models.TeamInvite||i().model("TeamInvite",a)},63253:(e,t,n)=>{n.d(t,{T:()=>o});var r=n(11185),i=n.n(r);let a=new r.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});a.index({email:1},{unique:!0}),a.index({workspaceId:1,role:1}),a.index({workspaceId:1,isActive:1});let o=i().models.User||i().model("User",a)},82279:(e,t,n)=>{n.d(t,{u:()=>o});var r=n(11185),i=n.n(r);let a=new r.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),o=i().models.Workspace||i().model("Workspace",a)},46993:(e,t,n)=>{n.d(t,{N:()=>o});var r=n(11185),i=n.n(r);let a=new r.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});a.index({workspaceId:1,userId:1},{unique:!0}),a.index({userId:1,isActive:1});let o=i().models.WorkspaceMembership||i().model("WorkspaceMembership",a)},940:(e,t,n)=>{n.d(t,{h:()=>i,r:()=>a});let r=new Map;function i(e){let t=Date.now();r.size>1e4&&function(e){for(let[t,n]of r)n.resetAt<=e&&r.delete(t)}(t);let n=r.get(e.key);return!n||n.resetAt<=t?(r.set(e.key,{count:1,resetAt:t+e.windowMs}),{ok:!0,remaining:Math.max(0,e.limit-1),retryAfterMs:0}):n.count>=e.limit?{ok:!1,remaining:0,retryAfterMs:Math.max(0,n.resetAt-t)}:(n.count+=1,r.set(e.key,n),{ok:!0,remaining:Math.max(0,e.limit-n.count),retryAfterMs:0})}function a(e){let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0]?.trim();if(e)return e}return e.headers.get("x-real-ip")??"unknown"}},88483:(e,t,n)=>{n.d(t,{CB:()=>s,CP:()=>f,IK:()=>m,Im:()=>l,It:()=>w,JE:()=>d,K9:()=>c,Ov:()=>u,Qm:()=>a,Qp:()=>I,VJ:()=>i,X5:()=>v,cM:()=>y,jt:()=>p,nf:()=>g,rP:()=>o});var r=n(69977);let i=r.Ryn({name:r.Z_8().min(1),email:r.Z_8().email().optional().or(r.i0J("")),phone:r.Z_8().optional().or(r.i0J("")),company:r.Z_8().optional().or(r.i0J("")),source:r.Z_8().optional(),sourceLabel:r.Z_8().optional(),stage:r.Z_8().optional(),nextFollowUpAt:r.Z_8().optional(),followUpCadence:r.KmV(["none","weekly","monthly","custom"]).optional(),followUpIntervalDays:r.Rxh().optional(),tags:r.IXX(r.Z_8()).optional(),notes:r.IXX(r.Ryn({id:r.Z_8(),body:r.Z_8(),createdAt:r.Z_8()})).optional(),archived:r.O72().optional()}),a=i.partial(),o=r.Ryn({title:r.Z_8().min(1),name:r.Z_8().optional(),contactId:r.Z_8().min(1).optional(),clientName:r.Z_8().optional(),status:r.Z_8().optional(),pipelineStage:r.Z_8().optional(),notes:r.Z_8().optional(),attachments:r.IXX(r.Ryn({id:r.Z_8().optional(),name:r.Z_8().min(1),url:r.Z_8().min(1),type:r.Z_8().optional().default(""),size:r.Rxh().nonnegative()})).optional(),startDate:r.Z_8().optional(),dueDate:r.Z_8().optional(),budgetAmount:r.Rxh().optional(),currency:r.Z_8().optional(),links:r.IXX(r.Z_8().url()).optional(),archived:r.O72().optional()}),s=o.partial().extend({removeAttachmentUrls:r.IXX(r.Z_8().min(1)).optional()}),l=r.Ryn({invoiceNo:r.Z_8().min(1),projectId:r.Z_8().min(1),contactId:r.Z_8().min(1),status:r.Z_8().optional(),issueDate:r.Z_8().optional(),dueDate:r.Z_8().optional(),paidDate:r.Z_8().optional(),amount:r.Rxh().optional(),currency:r.Z_8().optional(),lineItems:r.IXX(r.Ryn({title:r.Z_8(),qty:r.Rxh(),rate:r.Rxh()})).optional(),payments:r.IXX(r.Ryn({amount:r.Rxh(),method:r.Z_8(),paidAt:r.Z_8(),note:r.Z_8().optional()})).optional(),archived:r.O72().optional()}),d=l.partial(),p=r.Ryn({entityType:r.KmV(["contact","project","invoice","milestone"]),entityId:r.Z_8().min(1),action:r.Z_8().min(1),message:r.Z_8().optional(),userRole:r.Z_8().optional()}),c=p.partial(),u=r.Ryn({projectId:r.Z_8().min(1),title:r.Z_8().min(1),status:r.Z_8().optional(),dueDate:r.Z_8().optional(),amount:r.Rxh().optional(),currency:r.Z_8().optional(),order:r.Rxh().optional()}),m=u.partial(),w=r.Ryn({action:r.Z_8().min(1),entityType:r.Z_8().optional(),entityId:r.Z_8().optional(),meta:r.Z_8().optional()}),y=r.Ryn({name:r.Z_8().min(1),email:r.Z_8().email(),role:r.KmV(["Owner","Editor"]),password:r.Z_8().min(8)}),f=r.Ryn({name:r.Z_8().min(1).optional(),role:r.KmV(["Owner","Editor"]).optional(),isActive:r.O72().optional(),password:r.Z_8().min(8).optional()}),g=r.Ryn({orgName:r.Z_8().min(1),timezone:r.Z_8().min(1),logoUrl:r.Z_8().optional()}),I=r.Ryn({name:r.Z_8().min(1).optional(),avatarUrl:r.Z_8().min(1).optional().or(r.i0J(""))}),v=r.Ryn({email:r.Z_8().email(),name:r.Z_8().optional().or(r.i0J("")),role:r.KmV(["Owner","Editor"])});r.Ryn({status:r.KmV(["revoked"]).optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9379,6936,2960,4833,9977],()=>n(44551));module.exports=r})();