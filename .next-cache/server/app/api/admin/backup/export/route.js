"use strict";(()=>{var e={};e.id=8227,e.ids=[8227],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35690:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>_,requestAsyncStorage:()=>x,routeModule:()=>q,serverHooks:()=>h,staticGenerationAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{GET:()=>k});var i=r(73278),a=r(45002),d=r(54877),o=r(71309),s=r(48948),p=r(73275),l=r(49888),u=r(65278),c=r(57502),y=r(98876),g=r(97713),m=r(63253),S=r(32626),w=r(79551),f=r(35161),I=r(62272);async function k(e){let t;try{if(t=await (0,p.oT)(e),"owner"!==t.role)return o.NextResponse.json({success:!1,error:"Forbidden"},{status:403})}catch{return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}await (0,s.C)();let r={workspaceId:t.workspaceId},[n,i,a,d,k,q,x,v,h]=await Promise.all([l.V.find(r).lean(),u.X.find(r).lean(),c.S.find(r).lean(),y.f.find(r).lean(),g.p.find(r).lean(),m.T.find(r).lean(),S.a.find(r).lean(),f._.find(r).lean(),I.w.find(r).lean()]);return await w.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:t.workspaceId,createdAt:new Date().toISOString(),actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"Backup export",entityType:"backup"}),o.NextResponse.json({success:!0,data:{version:1,workspaceId:t.workspaceId,exportedAt:new Date().toISOString(),contacts:n,projects:i,invoices:a,milestones:d,activities:k,chat:v,notifications:h,users:q,settings:x}})}let q=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/backup/export/route",pathname:"/api/admin/backup/export",filename:"route",bundlePath:"app/api/admin/backup/export/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\admin\\backup\\export\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:h}=q,A="/api/admin/backup/export/route";function _(){return(0,d.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:v})}},73275:(e,t,r)=>{r.d(t,{KF:()=>h,MH:()=>I,XC:()=>x,Zk:()=>v,hg:()=>q,kt:()=>S,oT:()=>f,ts:()=>k,v6:()=>w});var n=r(52845),i=r(67370),a=r(32914),d=r(63253),o=r(82279),s=r(46993),p=r(48948);let l="vaultflow_session",u="vaultflow_workspace";function c(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function y(e){return"owner"===e.toLowerCase()?"owner":"editor"}function g(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function m(e,t,r){await (0,p.C)();let n=await d.T.findById(e).lean();if(!n||!n.isActive)return null;let i=r||t||n.workspaceId;if(i===n.workspaceId)return{workspaceId:i,role:y(n.role),email:n.email,name:n.name};let a=await s.N.findOne({userId:e,workspaceId:i,isActive:!0}).lean();return a?{workspaceId:i,role:"owner"===a.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:y(n.role),email:n.email,name:n.name}}async function S(e){let t=Math.floor(Date.now()/1e3);return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(c())}async function w(e){try{let t=e.headers.get("cookie"),r=g(t,l);if(!r)return null;let{payload:n}=await (0,a._)(r,c()),i="string"==typeof n.userId?n.userId:"",d="string"==typeof n.workspaceId?n.workspaceId:"",o=g(t,u);if(!i)return null;let s=await m(i,d,o);if(!s)return null;return{userId:i,workspaceId:s.workspaceId,role:s.role,email:s.email,name:s.name}}catch{return null}}async function f(e){let t=await w(e);if(!t)throw Error("Unauthorized");return t}async function I(e,t){let r=await f(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function k(){let e=(0,n.cookies)(),t=e.get(l)?.value;if(!t)return null;try{let{payload:r}=await (0,a._)(t,c()),n="string"==typeof r.userId?r.userId:"",i="string"==typeof r.workspaceId?r.workspaceId:"",o=e.get(u)?.value??"";if(!n)return null;let s=await m(n,i,o);if(!s)return null;let p=await d.T.findById(n).lean();if(!p||!p.isActive)return null;return{id:String(p._id),workspaceId:s.workspaceId,name:p.name,email:p.email,role:s.role,avatarUrl:p.avatarUrl??""}}catch{return null}}async function q(){let e=await k();if(!e)return[];await (0,p.C)();let t=await d.T.findById(e.id).lean();if(!t)return[];let r=await s.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),i=await o.u.find({_id:{$in:n},isActive:!0}).lean();if(!i.some(e=>String(e._id)===String(t.workspaceId))){let e=await o.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&i.push(e)}return n.map(n=>{let a=i.find(e=>String(e._id)===n),d=r.find(e=>String(e.workspaceId)===n),o=n===String(t.workspaceId)?"owner":d?.role==="owner"?"owner":"editor";return{id:n,name:a?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:o,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function x(){let e=await k();return e?.role??null}async function v(){return l}async function h(){return u}},48948:(e,t,r)=>{r.d(t,{C:()=>o});var n=r(11185),i=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("MONGODB_URI is not defined");let d=global.mongoose??{conn:null,promise:null};async function o(){return d.conn||(d.promise||(d.promise=i().connect(a).then(e=>e)),d.conn=await d.promise,global.mongoose=d),d.conn}},97713:(e,t,r)=>{r.d(t,{p:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},entityType:{type:String,required:!0},entityId:{type:String,required:!0},action:{type:String,required:!0},message:{type:String},userRole:{type:String}},{timestamps:!0});a.index({workspaceId:1,entityType:1,entityId:1,createdAt:-1});let d=i().models.Activity||i().model("Activity",a)},79551:(e,t,r)=>{r.d(t,{u:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),d=i().models.Audit||i().model("Audit",a)},35161:(e,t,r)=>{r.d(t,{_:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},entityType:{type:String,enum:["contact","project","global"],required:!0},entityId:{type:String,required:!0},body:{type:String,required:!0},senderId:{type:String,required:!0},senderName:{type:String,required:!0},senderRole:{type:String,required:!0},createdAt:{type:String,required:!0},pinnedAt:{type:String},readBy:{type:[String],default:[]}},{timestamps:!1});i().models.ChatMessage&&i().deleteModel("ChatMessage");let d=i().models.ChatMessage||i().model("ChatMessage",a)},49888:(e,t,r)=>{r.d(t,{V:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},name:{type:String,required:!0},email:{type:String,default:""},phone:{type:String,default:""},company:{type:String,default:""},source:{type:String,default:"other"},sourceLabel:{type:String},stage:{type:String,default:"new"},nextFollowUpAt:{type:String},followUpCadence:{type:String,default:"none"},followUpIntervalDays:{type:Number,default:0},tags:{type:[String],default:[]},notes:{type:[{id:String,body:String,createdAt:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,stage:1,archived:1}),a.index({workspaceId:1,nextFollowUpAt:1}),a.index({workspaceId:1,updatedAt:-1});let d=i().models.Contact||i().model("Contact",a)},57502:(e,t,r)=>{r.d(t,{S:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},invoiceNo:{type:String,required:!0},projectId:{type:String,required:!0},contactId:{type:String,required:!0},status:{type:String,enum:["draft","sent","paid","overdue","unpaid"],default:"unpaid"},issueDate:{type:String},dueDate:{type:String},paidDate:{type:String},amount:{type:Number},currency:{type:String,default:"USD"},lineItems:{type:[{title:String,qty:Number,rate:Number}],default:[]},payments:{type:[{amount:Number,method:String,paidAt:String,note:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,invoiceNo:1},{unique:!0}),a.index({workspaceId:1,status:1,archived:1}),a.index({workspaceId:1,dueDate:1}),a.index({workspaceId:1,projectId:1});let d=i().models.Invoice||i().model("Invoice",a)},98876:(e,t,r)=>{r.d(t,{f:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},projectId:{type:String,required:!0},title:{type:String,required:!0},status:{type:String,default:"pending"},dueDate:{type:String},amount:{type:Number,default:0},currency:{type:String,default:"USD"},order:{type:Number,default:0}},{timestamps:!0});a.index({workspaceId:1,projectId:1,status:1}),a.index({workspaceId:1,dueDate:1});let d=i().models.Milestone||i().model("Milestone",a)},62272:(e,t,r)=>{r.d(t,{w:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},title:{type:String,required:!0},body:{type:String,required:!0},type:{type:String,required:!0},entityType:{type:String},entityId:{type:String},createdAt:{type:String,required:!0},readBy:{type:[String],default:[]}},{timestamps:!1});a.index({workspaceId:1,createdAt:-1});let d=i().models.Notification||i().model("Notification",a)},65278:(e,t,r)=>{r.d(t,{X:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({id:String,name:String,url:String,type:String,size:Number},{_id:!1}),d=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},contactId:{type:String,required:!1,default:void 0},clientName:{type:String},title:{type:String,required:!0},name:{type:String},status:{type:String,default:"planning"},pipelineStage:{type:String},notes:{type:String},attachments:{type:[a],default:[]},startDate:{type:String},dueDate:{type:String},budgetAmount:{type:Number,default:0},currency:{type:String,default:"USD"},links:{type:[String],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});d.index({workspaceId:1,status:1,archived:1}),d.index({workspaceId:1,contactId:1}),d.index({workspaceId:1,dueDate:1}),d.index({workspaceId:1,updatedAt:-1}),i().models.Project&&i().deleteModel("Project");let o=i().models.Project||i().model("Project",d)},32626:(e,t,r)=>{r.d(t,{a:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},orgName:{type:String,default:"Flowlane"},timezone:{type:String,default:"UTC"},logoUrl:{type:String,default:""},updatedAt:{type:String,required:!0}},{timestamps:!1}),d=i().models.Settings||i().model("Settings",a)},63253:(e,t,r)=>{r.d(t,{T:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});a.index({email:1},{unique:!0}),a.index({workspaceId:1,role:1}),a.index({workspaceId:1,isActive:1});let d=i().models.User||i().model("User",a)},82279:(e,t,r)=>{r.d(t,{u:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),d=i().models.Workspace||i().model("Workspace",a)},46993:(e,t,r)=>{r.d(t,{N:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});a.index({workspaceId:1,userId:1},{unique:!0}),a.index({userId:1,isActive:1});let d=i().models.WorkspaceMembership||i().model("WorkspaceMembership",a)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833],()=>r(35690));module.exports=n})();