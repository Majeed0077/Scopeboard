"use strict";(()=>{var e={};e.id=2865,e.ids=[2865],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},10175:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>_,requestAsyncStorage:()=>v,routeModule:()=>q,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{POST:()=>k});var n=r(73278),a=r(45002),d=r(54877),o=r(71309),s=r(48948),p=r(73275),u=r(49888),l=r(65278),c=r(57502),y=r(98876),g=r(97713),m=r(63253),S=r(32626),w=r(79551),f=r(35161),I=r(62272);async function k(e){let t;try{if(t=await (0,p.oT)(e),"owner"!==t.role)return o.NextResponse.json({success:!1,error:"Forbidden"},{status:403})}catch{return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}let r=await e.json();if(!r||"object"!=typeof r)return o.NextResponse.json({success:!1,error:"Invalid payload"},{status:400});if(r.workspaceId&&r.workspaceId!==t.workspaceId)return o.NextResponse.json({success:!1,error:"Workspace mismatch"},{status:403});await (0,s.C)();let i=async(e,r)=>{if(!Array.isArray(r)||0===r.length)return;let i=r.map(e=>({updateOne:{filter:{_id:e._id,workspaceId:t.workspaceId},update:{...e,workspaceId:t.workspaceId},upsert:!0}}));await e.bulkWrite(i)};return await i(u.V,r.contacts??[]),await i(l.X,r.projects??[]),await i(c.S,r.invoices??[]),await i(y.f,r.milestones??[]),await i(g.p,r.activities??[]),await i(f._,r.chat??[]),await i(I.w,r.notifications??[]),await i(m.T,r.users??[]),await i(S.a,r.settings??[]),await w.u.create({_id:`aud-${crypto.randomUUID().slice(0,8)}`,workspaceId:t.workspaceId,createdAt:new Date().toISOString(),actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"Backup import",entityType:"backup"}),o.NextResponse.json({success:!0,data:{importedAt:new Date().toISOString()}})}let q=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/backup/import/route",pathname:"/api/admin/backup/import",filename:"route",bundlePath:"app/api/admin/backup/import/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\admin\\backup\\import\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:v,staticGenerationAsyncStorage:x,serverHooks:h}=q,A="/api/admin/backup/import/route";function _(){return(0,d.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},73275:(e,t,r)=>{r.d(t,{KF:()=>h,MH:()=>I,XC:()=>v,Zk:()=>x,hg:()=>q,kt:()=>S,oT:()=>f,ts:()=>k,v6:()=>w});var i=r(52845),n=r(67370),a=r(32914),d=r(63253),o=r(82279),s=r(46993),p=r(48948);let u="vaultflow_session",l="vaultflow_workspace";function c(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function y(e){return"owner"===e.toLowerCase()?"owner":"editor"}function g(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function m(e,t,r){await (0,p.C)();let i=await d.T.findById(e).lean();if(!i||!i.isActive)return null;let n=r||t||i.workspaceId;if(n===i.workspaceId)return{workspaceId:n,role:y(i.role),email:i.email,name:i.name};let a=await s.N.findOne({userId:e,workspaceId:n,isActive:!0}).lean();return a?{workspaceId:n,role:"owner"===a.role?"owner":"editor",email:i.email,name:i.name}:{workspaceId:i.workspaceId,role:y(i.role),email:i.email,name:i.name}}async function S(e){let t=Math.floor(Date.now()/1e3);return new n.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(c())}async function w(e){try{let t=e.headers.get("cookie"),r=g(t,u);if(!r)return null;let{payload:i}=await (0,a._)(r,c()),n="string"==typeof i.userId?i.userId:"",d="string"==typeof i.workspaceId?i.workspaceId:"",o=g(t,l);if(!n)return null;let s=await m(n,d,o);if(!s)return null;return{userId:n,workspaceId:s.workspaceId,role:s.role,email:s.email,name:s.name}}catch{return null}}async function f(e){let t=await w(e);if(!t)throw Error("Unauthorized");return t}async function I(e,t){let r=await f(e),i="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==i)throw Error("Forbidden");return r}async function k(){let e=(0,i.cookies)(),t=e.get(u)?.value;if(!t)return null;try{let{payload:r}=await (0,a._)(t,c()),i="string"==typeof r.userId?r.userId:"",n="string"==typeof r.workspaceId?r.workspaceId:"",o=e.get(l)?.value??"";if(!i)return null;let s=await m(i,n,o);if(!s)return null;let p=await d.T.findById(i).lean();if(!p||!p.isActive)return null;return{id:String(p._id),workspaceId:s.workspaceId,name:p.name,email:p.email,role:s.role,avatarUrl:p.avatarUrl??""}}catch{return null}}async function q(){let e=await k();if(!e)return[];await (0,p.C)();let t=await d.T.findById(e.id).lean();if(!t)return[];let r=await s.N.find({userId:e.id,isActive:!0}).lean(),i=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),n=await o.u.find({_id:{$in:i},isActive:!0}).lean();if(!n.some(e=>String(e._id)===String(t.workspaceId))){let e=await o.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&n.push(e)}return i.map(i=>{let a=n.find(e=>String(e._id)===i),d=r.find(e=>String(e.workspaceId)===i),o=i===String(t.workspaceId)?"owner":d?.role==="owner"?"owner":"editor";return{id:i,name:a?.name??(i===String(t.workspaceId)?"My Workspace":`Workspace ${i.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:o,isPersonal:i===String(t.workspaceId),isActive:i===e.workspaceId}})}async function v(){let e=await k();return e?.role??null}async function x(){return u}async function h(){return l}},48948:(e,t,r)=>{r.d(t,{C:()=>o});var i=r(11185),n=r.n(i);let a=process.env.MONGODB_URI;if(!a)throw Error("MONGODB_URI is not defined");let d=global.mongoose??{conn:null,promise:null};async function o(){return d.conn||(d.promise||(d.promise=n().connect(a).then(e=>e)),d.conn=await d.promise,global.mongoose=d),d.conn}},97713:(e,t,r)=>{r.d(t,{p:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},entityType:{type:String,required:!0},entityId:{type:String,required:!0},action:{type:String,required:!0},message:{type:String},userRole:{type:String}},{timestamps:!0});a.index({workspaceId:1,entityType:1,entityId:1,createdAt:-1});let d=n().models.Activity||n().model("Activity",a)},79551:(e,t,r)=>{r.d(t,{u:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),d=n().models.Audit||n().model("Audit",a)},35161:(e,t,r)=>{r.d(t,{_:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},entityType:{type:String,enum:["contact","project","global"],required:!0},entityId:{type:String,required:!0},body:{type:String,required:!0},senderId:{type:String,required:!0},senderName:{type:String,required:!0},senderRole:{type:String,required:!0},createdAt:{type:String,required:!0},pinnedAt:{type:String},readBy:{type:[String],default:[]}},{timestamps:!1});n().models.ChatMessage&&n().deleteModel("ChatMessage");let d=n().models.ChatMessage||n().model("ChatMessage",a)},49888:(e,t,r)=>{r.d(t,{V:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},name:{type:String,required:!0},email:{type:String,default:""},phone:{type:String,default:""},company:{type:String,default:""},source:{type:String,default:"other"},sourceLabel:{type:String},stage:{type:String,default:"new"},nextFollowUpAt:{type:String},followUpCadence:{type:String,default:"none"},followUpIntervalDays:{type:Number,default:0},tags:{type:[String],default:[]},notes:{type:[{id:String,body:String,createdAt:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,stage:1,archived:1}),a.index({workspaceId:1,nextFollowUpAt:1}),a.index({workspaceId:1,updatedAt:-1});let d=n().models.Contact||n().model("Contact",a)},57502:(e,t,r)=>{r.d(t,{S:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},invoiceNo:{type:String,required:!0},projectId:{type:String,required:!0},contactId:{type:String,required:!0},status:{type:String,enum:["draft","sent","paid","overdue","unpaid"],default:"unpaid"},issueDate:{type:String},dueDate:{type:String},paidDate:{type:String},amount:{type:Number},currency:{type:String,default:"USD"},lineItems:{type:[{title:String,qty:Number,rate:Number}],default:[]},payments:{type:[{amount:Number,method:String,paidAt:String,note:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,invoiceNo:1},{unique:!0}),a.index({workspaceId:1,status:1,archived:1}),a.index({workspaceId:1,dueDate:1}),a.index({workspaceId:1,projectId:1});let d=n().models.Invoice||n().model("Invoice",a)},98876:(e,t,r)=>{r.d(t,{f:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},projectId:{type:String,required:!0},title:{type:String,required:!0},status:{type:String,default:"pending"},dueDate:{type:String},amount:{type:Number,default:0},currency:{type:String,default:"USD"},order:{type:Number,default:0}},{timestamps:!0});a.index({workspaceId:1,projectId:1,status:1}),a.index({workspaceId:1,dueDate:1});let d=n().models.Milestone||n().model("Milestone",a)},62272:(e,t,r)=>{r.d(t,{w:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},title:{type:String,required:!0},body:{type:String,required:!0},type:{type:String,required:!0},entityType:{type:String},entityId:{type:String},createdAt:{type:String,required:!0},readBy:{type:[String],default:[]}},{timestamps:!1});a.index({workspaceId:1,createdAt:-1});let d=n().models.Notification||n().model("Notification",a)},65278:(e,t,r)=>{r.d(t,{X:()=>o});var i=r(11185),n=r.n(i);let a=new i.Schema({id:String,name:String,url:String,type:String,size:Number},{_id:!1}),d=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},contactId:{type:String,required:!1,default:void 0},clientName:{type:String},title:{type:String,required:!0},name:{type:String},status:{type:String,default:"planning"},pipelineStage:{type:String},notes:{type:String},attachments:{type:[a],default:[]},startDate:{type:String},dueDate:{type:String},budgetAmount:{type:Number,default:0},currency:{type:String,default:"USD"},links:{type:[String],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});d.index({workspaceId:1,status:1,archived:1}),d.index({workspaceId:1,contactId:1}),d.index({workspaceId:1,dueDate:1}),d.index({workspaceId:1,updatedAt:-1}),n().models.Project&&n().deleteModel("Project");let o=n().models.Project||n().model("Project",d)},32626:(e,t,r)=>{r.d(t,{a:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},orgName:{type:String,default:"Flowlane"},timezone:{type:String,default:"UTC"},logoUrl:{type:String,default:""},updatedAt:{type:String,required:!0}},{timestamps:!1}),d=n().models.Settings||n().model("Settings",a)},63253:(e,t,r)=>{r.d(t,{T:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});a.index({email:1},{unique:!0}),a.index({workspaceId:1,role:1}),a.index({workspaceId:1,isActive:1});let d=n().models.User||n().model("User",a)},82279:(e,t,r)=>{r.d(t,{u:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),d=n().models.Workspace||n().model("Workspace",a)},46993:(e,t,r)=>{r.d(t,{N:()=>d});var i=r(11185),n=r.n(i);let a=new i.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});a.index({workspaceId:1,userId:1},{unique:!0}),a.index({userId:1,isActive:1});let d=n().models.WorkspaceMembership||n().model("WorkspaceMembership",a)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9379,6936,2960,4833],()=>r(10175));module.exports=i})();