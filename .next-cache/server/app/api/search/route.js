"use strict";(()=>{var e={};e.id=280,e.ids=[280],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},41533:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>k,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>S,staticGenerationAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{GET:()=>w});var i=r(73278),a=r(45002),o=r(54877),d=r(71309),s=r(48948),l=r(49888),u=r(65278),c=r(57502),p=r(73275),m=r(93133);async function w(e){let t;try{t=await (0,p.oT)(e)}catch{return d.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}let{searchParams:r}=new URL(e.url),n=r.get("q")?.trim()??"";if(!n)return d.NextResponse.json({success:!0,data:{contacts:[],projects:[],invoices:[]}});await (0,s.C)();let i=RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a={workspaceId:t.workspaceId},[o,w,g]=await Promise.all([l.V.find({...a,$or:[{name:i},{company:i}]}).limit(20).lean(),u.X.find({...a,$or:[{title:i},{clientName:i}]}).limit(20).lean(),c.S.find({...a,invoiceNo:i}).limit(20).lean()]),f=g.map(e=>(0,m.xr)({id:e._id,...e},t.role));return d.NextResponse.json({success:!0,data:{contacts:o.map(e=>({id:e._id,...e})),projects:w.map(e=>({id:e._id,...e})),invoices:f}})}let g=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/search/route",pathname:"/api/search",filename:"route",bundlePath:"app/api/search/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\search\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:S}=g,I="/api/search/route";function k(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:y})}},73275:(e,t,r)=>{r.d(t,{KF:()=>q,MH:()=>I,XC:()=>h,Zk:()=>x,hg:()=>v,kt:()=>f,oT:()=>S,ts:()=>k,v6:()=>y});var n=r(52845),i=r(67370),a=r(32914),o=r(63253),d=r(82279),s=r(46993),l=r(48948);let u="vaultflow_session",c="vaultflow_workspace";function p(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function m(e){return"owner"===e.toLowerCase()?"owner":"editor"}function w(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function g(e,t,r){await (0,l.C)();let n=await o.T.findById(e).lean();if(!n||!n.isActive)return null;let i=r||t||n.workspaceId;if(i===n.workspaceId)return{workspaceId:i,role:m(n.role),email:n.email,name:n.name};let a=await s.N.findOne({userId:e,workspaceId:i,isActive:!0}).lean();return a?{workspaceId:i,role:"owner"===a.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:m(n.role),email:n.email,name:n.name}}async function f(e){let t=Math.floor(Date.now()/1e3);return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(p())}async function y(e){try{let t=e.headers.get("cookie"),r=w(t,u);if(!r)return null;let{payload:n}=await (0,a._)(r,p()),i="string"==typeof n.userId?n.userId:"",o="string"==typeof n.workspaceId?n.workspaceId:"",d=w(t,c);if(!i)return null;let s=await g(i,o,d);if(!s)return null;return{userId:i,workspaceId:s.workspaceId,role:s.role,email:s.email,name:s.name}}catch{return null}}async function S(e){let t=await y(e);if(!t)throw Error("Unauthorized");return t}async function I(e,t){let r=await S(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function k(){let e=(0,n.cookies)(),t=e.get(u)?.value;if(!t)return null;try{let{payload:r}=await (0,a._)(t,p()),n="string"==typeof r.userId?r.userId:"",i="string"==typeof r.workspaceId?r.workspaceId:"",d=e.get(c)?.value??"";if(!n)return null;let s=await g(n,i,d);if(!s)return null;let l=await o.T.findById(n).lean();if(!l||!l.isActive)return null;return{id:String(l._id),workspaceId:s.workspaceId,name:l.name,email:l.email,role:s.role,avatarUrl:l.avatarUrl??""}}catch{return null}}async function v(){let e=await k();if(!e)return[];await (0,l.C)();let t=await o.T.findById(e.id).lean();if(!t)return[];let r=await s.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),i=await d.u.find({_id:{$in:n},isActive:!0}).lean();if(!i.some(e=>String(e._id)===String(t.workspaceId))){let e=await d.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&i.push(e)}return n.map(n=>{let a=i.find(e=>String(e._id)===n),o=r.find(e=>String(e.workspaceId)===n),d=n===String(t.workspaceId)?"owner":o?.role==="owner"?"owner":"editor";return{id:n,name:a?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:d,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function h(){let e=await k();return e?.role??null}async function x(){return u}async function q(){return c}},48948:(e,t,r)=>{r.d(t,{C:()=>d});var n=r(11185),i=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("MONGODB_URI is not defined");let o=global.mongoose??{conn:null,promise:null};async function d(){return o.conn||(o.promise||(o.promise=i().connect(a).then(e=>e)),o.conn=await o.promise,global.mongoose=o),o.conn}},49888:(e,t,r)=>{r.d(t,{V:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},name:{type:String,required:!0},email:{type:String,default:""},phone:{type:String,default:""},company:{type:String,default:""},source:{type:String,default:"other"},sourceLabel:{type:String},stage:{type:String,default:"new"},nextFollowUpAt:{type:String},followUpCadence:{type:String,default:"none"},followUpIntervalDays:{type:Number,default:0},tags:{type:[String],default:[]},notes:{type:[{id:String,body:String,createdAt:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,stage:1,archived:1}),a.index({workspaceId:1,nextFollowUpAt:1}),a.index({workspaceId:1,updatedAt:-1});let o=i().models.Contact||i().model("Contact",a)},57502:(e,t,r)=>{r.d(t,{S:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},invoiceNo:{type:String,required:!0},projectId:{type:String,required:!0},contactId:{type:String,required:!0},status:{type:String,enum:["draft","sent","paid","overdue","unpaid"],default:"unpaid"},issueDate:{type:String},dueDate:{type:String},paidDate:{type:String},amount:{type:Number},currency:{type:String,default:"USD"},lineItems:{type:[{title:String,qty:Number,rate:Number}],default:[]},payments:{type:[{amount:Number,method:String,paidAt:String,note:String}],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,invoiceNo:1},{unique:!0}),a.index({workspaceId:1,status:1,archived:1}),a.index({workspaceId:1,dueDate:1}),a.index({workspaceId:1,projectId:1});let o=i().models.Invoice||i().model("Invoice",a)},65278:(e,t,r)=>{r.d(t,{X:()=>d});var n=r(11185),i=r.n(n);let a=new n.Schema({id:String,name:String,url:String,type:String,size:Number},{_id:!1}),o=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},contactId:{type:String,required:!1,default:void 0},clientName:{type:String},title:{type:String,required:!0},name:{type:String},status:{type:String,default:"planning"},pipelineStage:{type:String},notes:{type:String},attachments:{type:[a],default:[]},startDate:{type:String},dueDate:{type:String},budgetAmount:{type:Number,default:0},currency:{type:String,default:"USD"},links:{type:[String],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});o.index({workspaceId:1,status:1,archived:1}),o.index({workspaceId:1,contactId:1}),o.index({workspaceId:1,dueDate:1}),o.index({workspaceId:1,updatedAt:-1}),i().models.Project&&i().deleteModel("Project");let d=i().models.Project||i().model("Project",o)},63253:(e,t,r)=>{r.d(t,{T:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});a.index({email:1},{unique:!0}),a.index({workspaceId:1,role:1}),a.index({workspaceId:1,isActive:1});let o=i().models.User||i().model("User",a)},82279:(e,t,r)=>{r.d(t,{u:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),o=i().models.Workspace||i().model("Workspace",a)},46993:(e,t,r)=>{r.d(t,{N:()=>o});var n=r(11185),i=r.n(n);let a=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});a.index({workspaceId:1,userId:1},{unique:!0}),a.index({userId:1,isActive:1});let o=i().models.WorkspaceMembership||i().model("WorkspaceMembership",a)},93133:(e,t,r)=>{function n(e,t){if("owner"===t)return e;let{amount:r,currency:n,paidDate:i,lineItems:a,payments:o,...d}=e;return d}function i(e,t){if("owner"!==t&&["amount","currency","paidDate","lineItems","payments","status"].some(t=>t in e))throw Error("Editor cannot modify finance fields.")}function a(e,t){if("owner"===t)return e;let{budgetAmount:r,currency:n,...i}=e;return i}function o(e,t){if("owner"!==t&&["budgetAmount","currency","budget"].some(t=>t in e))throw Error("Editor cannot modify budget fields.")}r.d(t,{Ak:()=>o,Jr:()=>a,KL:()=>i,xr:()=>n})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833],()=>r(41533));module.exports=n})();