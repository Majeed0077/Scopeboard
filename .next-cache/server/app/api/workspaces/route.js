"use strict";(()=>{var e={};e.id=2694,e.ids=[2694],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},6968:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>I,serverHooks:()=>y,staticGenerationAsyncStorage:()=>k});var n={};t.r(n),t.d(n,{GET:()=>m,POST:()=>f});var a=t(73278),i=t(45002),o=t(54877),s=t(71309),d=t(84770),l=t(48948),c=t(73275),u=t(63253),p=t(82279),w=t(46993);async function m(e){let r;try{r=await (0,c.oT)(e)}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}await (0,l.C)();let t=await u.T.findById(r.userId).lean();if(!t)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let n=await w.N.find({userId:r.userId,isActive:!0}).lean(),a=Array.from(new Set([t.workspaceId,...n.map(e=>e.workspaceId)])),i=await p.u.find({_id:{$in:a},isActive:!0}).lean();if(!i.some(e=>String(e._id)===t.workspaceId)){let e=await p.u.findOneAndUpdate({_id:t.workspaceId},{_id:t.workspaceId,name:`${t.name}'s Workspace`,logoUrl:"",ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&i.push(e)}let o=a.map(e=>{let a=i.find(r=>String(r._id)===e),o=n.find(r=>r.workspaceId===e),s=e===t.workspaceId?"owner":o?.role??"editor";return{id:e,name:a?.name??(e===t.workspaceId?"My Workspace":`Workspace ${e.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:s,isPersonal:e===t.workspaceId,isActive:e===r.workspaceId}});return s.NextResponse.json({success:!0,data:o})}async function f(e){let r;try{r=await (0,c.oT)(e)}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}let t=await e.json().catch(()=>({})),n="string"==typeof t.name?t.name.trim():"";if(!n||n.length<2)return s.NextResponse.json({success:!1,error:"Workspace name is required."},{status:400});await (0,l.C)();let a=`ws-${(0,d.randomUUID)().slice(0,8)}`,i=await p.u.create({_id:a,name:n,logoUrl:"",ownerUserId:r.userId,isActive:!0});return await w.N.create({userId:r.userId,workspaceId:a,role:"owner",isActive:!0,invitedById:r.userId}).catch(()=>void 0),s.NextResponse.json({success:!0,data:{id:String(i._id),name:i.name,logoUrl:i.logoUrl??"",role:"owner",isPersonal:!1}})}let I=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/workspaces/route",pathname:"/api/workspaces",filename:"route",bundlePath:"app/api/workspaces/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\workspaces\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:k,serverHooks:y}=I,v="/api/workspaces/route";function S(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:k})}},73275:(e,r,t)=>{t.d(r,{KF:()=>U,MH:()=>y,XC:()=>h,Zk:()=>x,hg:()=>S,kt:()=>I,oT:()=>k,ts:()=>v,v6:()=>g});var n=t(52845),a=t(67370),i=t(32914),o=t(63253),s=t(82279),d=t(46993),l=t(48948);let c="vaultflow_session",u="vaultflow_workspace";function p(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function w(e){return"owner"===e.toLowerCase()?"owner":"editor"}function m(e,r){if(!e)return"";for(let t of e.split(";").map(e=>e.trim()))if(t.startsWith(`${r}=`))return decodeURIComponent(t.slice(`${r}=`.length));return""}async function f(e,r,t){await (0,l.C)();let n=await o.T.findById(e).lean();if(!n||!n.isActive)return null;let a=t||r||n.workspaceId;if(a===n.workspaceId)return{workspaceId:a,role:w(n.role),email:n.email,name:n.name};let i=await d.N.findOne({userId:e,workspaceId:a,isActive:!0}).lean();return i?{workspaceId:a,role:"owner"===i.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:w(n.role),email:n.email,name:n.name}}async function I(e){let r=Math.floor(Date.now()/1e3);return new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(r).setExpirationTime(r+604800).sign(p())}async function g(e){try{let r=e.headers.get("cookie"),t=m(r,c);if(!t)return null;let{payload:n}=await (0,i._)(t,p()),a="string"==typeof n.userId?n.userId:"",o="string"==typeof n.workspaceId?n.workspaceId:"",s=m(r,u);if(!a)return null;let d=await f(a,o,s);if(!d)return null;return{userId:a,workspaceId:d.workspaceId,role:d.role,email:d.email,name:d.name}}catch{return null}}async function k(e){let r=await g(e);if(!r)throw Error("Unauthorized");return r}async function y(e,r){let t=await k(e),n="owner"===r.toLowerCase()?"owner":"editor";if(t.role!==n)throw Error("Forbidden");return t}async function v(){let e=(0,n.cookies)(),r=e.get(c)?.value;if(!r)return null;try{let{payload:t}=await (0,i._)(r,p()),n="string"==typeof t.userId?t.userId:"",a="string"==typeof t.workspaceId?t.workspaceId:"",s=e.get(u)?.value??"";if(!n)return null;let d=await f(n,a,s);if(!d)return null;let l=await o.T.findById(n).lean();if(!l||!l.isActive)return null;return{id:String(l._id),workspaceId:d.workspaceId,name:l.name,email:l.email,role:d.role,avatarUrl:l.avatarUrl??""}}catch{return null}}async function S(){let e=await v();if(!e)return[];await (0,l.C)();let r=await o.T.findById(e.id).lean();if(!r)return[];let t=await d.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(r.workspaceId),...t.map(e=>String(e.workspaceId))])),a=await s.u.find({_id:{$in:n},isActive:!0}).lean();if(!a.some(e=>String(e._id)===String(r.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(r.workspaceId)},{_id:String(r.workspaceId),name:`${r.name}'s Workspace`,ownerUserId:String(r._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&a.push(e)}return n.map(n=>{let i=a.find(e=>String(e._id)===n),o=t.find(e=>String(e.workspaceId)===n),s=n===String(r.workspaceId)?"owner":o?.role==="owner"?"owner":"editor";return{id:n,name:i?.name??(n===String(r.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:i?.logoUrl??"",role:s,isPersonal:n===String(r.workspaceId),isActive:n===e.workspaceId}})}async function h(){let e=await v();return e?.role??null}async function x(){return c}async function U(){return u}},48948:(e,r,t)=>{t.d(r,{C:()=>s});var n=t(11185),a=t.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("MONGODB_URI is not defined");let o=global.mongoose??{conn:null,promise:null};async function s(){return o.conn||(o.promise||(o.promise=a().connect(i).then(e=>e)),o.conn=await o.promise,global.mongoose=o),o.conn}},63253:(e,r,t)=>{t.d(r,{T:()=>o});var n=t(11185),a=t.n(n);let i=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});i.index({email:1},{unique:!0}),i.index({workspaceId:1,role:1}),i.index({workspaceId:1,isActive:1});let o=a().models.User||a().model("User",i)},82279:(e,r,t)=>{t.d(r,{u:()=>o});var n=t(11185),a=t.n(n);let i=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),o=a().models.Workspace||a().model("Workspace",i)},46993:(e,r,t)=>{t.d(r,{N:()=>o});var n=t(11185),a=t.n(n);let i=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});i.index({workspaceId:1,userId:1},{unique:!0}),i.index({userId:1,isActive:1});let o=a().models.WorkspaceMembership||a().model("WorkspaceMembership",i)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[9379,6936,2960,4833],()=>t(6968));module.exports=n})();