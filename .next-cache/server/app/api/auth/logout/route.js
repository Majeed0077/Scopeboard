"use strict";(()=>{var e={};e.id=7716,e.ids=[7716],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92672:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{POST:()=>u});var a=r(73278),i=r(45002),o=r(54877),s=r(71309),l=r(73275),d=r(84758);async function u(e){let t=await (0,l.v6)(e),r=s.NextResponse.json({success:!0});return r.cookies.set(await (0,l.Zk)(),"",{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,expires:new Date(0)}),r.cookies.set(await (0,l.KF)(),"",{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,expires:new Date(0)}),t&&await (0,d.b)({actorId:t.userId,actorRole:t.role,actorEmail:t.email,action:"auth.logout",meta:`Logout for ${t.email}`,workspaceId:t.workspaceId}),r}let c=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/logout/route",pathname:"/api/auth/logout",filename:"route",bundlePath:"app/api/auth/logout/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\auth\\logout\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:w,serverHooks:m}=c,g="/api/auth/logout/route";function f(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:w})}},84758:(e,t,r)=>{r.d(t,{b:()=>i});var n=r(48948),a=r(79551);async function i(e){await (0,n.C)();let t=`aud-${crypto.randomUUID().slice(0,8)}`;await a.u.create({_id:t,workspaceId:e.workspaceId??"default",createdAt:new Date().toISOString(),...e})}},73275:(e,t,r)=>{r.d(t,{KF:()=>q,MH:()=>k,XC:()=>h,Zk:()=>x,hg:()=>v,kt:()=>f,oT:()=>I,ts:()=>S,v6:()=>y});var n=r(52845),a=r(67370),i=r(32914),o=r(63253),s=r(82279),l=r(46993),d=r(48948);let u="vaultflow_session",c="vaultflow_workspace";function p(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function w(e){return"owner"===e.toLowerCase()?"owner":"editor"}function m(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function g(e,t,r){await (0,d.C)();let n=await o.T.findById(e).lean();if(!n||!n.isActive)return null;let a=r||t||n.workspaceId;if(a===n.workspaceId)return{workspaceId:a,role:w(n.role),email:n.email,name:n.name};let i=await l.N.findOne({userId:e,workspaceId:a,isActive:!0}).lean();return i?{workspaceId:a,role:"owner"===i.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:w(n.role),email:n.email,name:n.name}}async function f(e){let t=Math.floor(Date.now()/1e3);return new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(p())}async function y(e){try{let t=e.headers.get("cookie"),r=m(t,u);if(!r)return null;let{payload:n}=await (0,i._)(r,p()),a="string"==typeof n.userId?n.userId:"",o="string"==typeof n.workspaceId?n.workspaceId:"",s=m(t,c);if(!a)return null;let l=await g(a,o,s);if(!l)return null;return{userId:a,workspaceId:l.workspaceId,role:l.role,email:l.email,name:l.name}}catch{return null}}async function I(e){let t=await y(e);if(!t)throw Error("Unauthorized");return t}async function k(e,t){let r=await I(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function S(){let e=(0,n.cookies)(),t=e.get(u)?.value;if(!t)return null;try{let{payload:r}=await (0,i._)(t,p()),n="string"==typeof r.userId?r.userId:"",a="string"==typeof r.workspaceId?r.workspaceId:"",s=e.get(c)?.value??"";if(!n)return null;let l=await g(n,a,s);if(!l)return null;let d=await o.T.findById(n).lean();if(!d||!d.isActive)return null;return{id:String(d._id),workspaceId:l.workspaceId,name:d.name,email:d.email,role:l.role,avatarUrl:d.avatarUrl??""}}catch{return null}}async function v(){let e=await S();if(!e)return[];await (0,d.C)();let t=await o.T.findById(e.id).lean();if(!t)return[];let r=await l.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),a=await s.u.find({_id:{$in:n},isActive:!0}).lean();if(!a.some(e=>String(e._id)===String(t.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&a.push(e)}return n.map(n=>{let i=a.find(e=>String(e._id)===n),o=r.find(e=>String(e.workspaceId)===n),s=n===String(t.workspaceId)?"owner":o?.role==="owner"?"owner":"editor";return{id:n,name:i?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:i?.logoUrl??"",role:s,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function h(){let e=await S();return e?.role??null}async function x(){return u}async function q(){return c}},48948:(e,t,r)=>{r.d(t,{C:()=>s});var n=r(11185),a=r.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("MONGODB_URI is not defined");let o=global.mongoose??{conn:null,promise:null};async function s(){return o.conn||(o.promise||(o.promise=a().connect(i).then(e=>e)),o.conn=await o.promise,global.mongoose=o),o.conn}},79551:(e,t,r)=>{r.d(t,{u:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),o=a().models.Audit||a().model("Audit",i)},63253:(e,t,r)=>{r.d(t,{T:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});i.index({email:1},{unique:!0}),i.index({workspaceId:1,role:1}),i.index({workspaceId:1,isActive:1});let o=a().models.User||a().model("User",i)},82279:(e,t,r)=>{r.d(t,{u:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),o=a().models.Workspace||a().model("Workspace",i)},46993:(e,t,r)=>{r.d(t,{N:()=>o});var n=r(11185),a=r.n(n);let i=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});i.index({workspaceId:1,userId:1},{unique:!0}),i.index({userId:1,isActive:1});let o=a().models.WorkspaceMembership||a().model("WorkspaceMembership",i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833],()=>r(92672));module.exports=n})();