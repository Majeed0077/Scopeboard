"use strict";(()=>{var e={};e.id=3654,e.ids=[3654],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},1412:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>_,requestAsyncStorage:()=>v,routeModule:()=>x,serverHooks:()=>A,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{POST:()=>S});var i=r(73278),a=r(45002),s=r(54877),o=r(71309),d=r(69977),l=r(84770),u=r(48948),c=r(63253),p=r(45018),w=r(82279),m=r(46993),g=r(13634),f=r(73275),y=r(79551),I=r(940);let k=d.Ryn({name:d.Z_8().min(1),email:d.Z_8().email(),password:d.Z_8().min(6),inviteToken:d.Z_8().optional()});async function S(e){let t=await e.json(),r=k.safeParse(t);if(!r.success)return o.NextResponse.json({success:!1,error:r.error.flatten()},{status:400});let n=(0,I.r)(e);if(!(0,I.h)({key:`signup:${n}`,limit:20,windowMs:36e5}).ok)return o.NextResponse.json({success:!1,error:"Too many signup attempts. Try again later."},{status:429});await (0,u.C)();let i=r.data.email.toLowerCase(),a=await c.T.findOne({email:i}).lean(),s=null;if(r.data.inviteToken){if(!(s=await p.q.findOne({token:r.data.inviteToken}).lean()))return o.NextResponse.json({success:!1,error:"Invalid invite link."},{status:400});if(s.email!==i)return o.NextResponse.json({success:!1,error:"Invite email does not match."},{status:400});if("pending"!==s.status)return o.NextResponse.json({success:!1,error:"Invite is no longer active."},{status:400});if(new Date(s.expiresAt).getTime()<Date.now())return await p.q.findByIdAndUpdate(s._id,{status:"expired"}),o.NextResponse.json({success:!1,error:"Invite has expired."},{status:400})}if(a&&!s)return o.NextResponse.json({success:!1,error:"Email already in use."},{status:409});if(a&&s){if(!await (0,g.G)(r.data.password,a.passwordHash))return o.NextResponse.json({success:!1,error:"Use your existing account password to join this team."},{status:401});let e="Owner"===s.role?"owner":"editor";await m.N.updateOne({userId:String(a._id),workspaceId:s.workspaceId},{$set:{role:e,isActive:!0,invitedById:s.invitedById}},{upsert:!0}),await p.q.findByIdAndUpdate(s._id,{status:"accepted",acceptedAt:new Date,acceptedUserId:String(a._id)});let t=await (0,f.kt)({userId:String(a._id),workspaceId:String(a.workspaceId),role:"owner"===a.role.toLowerCase()?"owner":"editor",email:a.email,name:a.name}),n=o.NextResponse.json({success:!0,data:{id:String(a._id),name:a.name,email:a.email,role:"owner"===a.role.toLowerCase()?"owner":"editor"}});return n.cookies.set(await (0,f.Zk)(),t,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:604800}),n.cookies.set(await (0,f.KF)(),String(a.workspaceId),{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:2592e3}),n}let d=`ws-${(0,l.randomUUID)().slice(0,8)}`,S=await (0,g.c)(r.data.password),x=await c.T.create({email:i,name:r.data.name,role:"Owner",workspaceId:d,passwordHash:S,isActive:!0});if(await w.u.create({_id:d,name:`${r.data.name}'s Workspace`,ownerUserId:String(x._id),isActive:!0}),s){let e="Owner"===s.role?"owner":"editor";await m.N.updateOne({userId:String(x._id),workspaceId:s.workspaceId},{$set:{role:e,isActive:!0,invitedById:s.invitedById}},{upsert:!0}),await p.q.findByIdAndUpdate(s._id,{status:"accepted",acceptedAt:new Date,acceptedUserId:String(x._id)})}await y.u.create({_id:`aud-${(0,l.randomUUID)().slice(0,8)}`,workspaceId:d,createdAt:new Date().toISOString(),actorId:String(x._id),actorRole:"owner",actorEmail:x.email,action:s?"User signed up and joined invited workspace":"Workspace owner signed up",entityType:"user",entityId:String(x._id),meta:x.email});let v=await (0,f.kt)({userId:String(x._id),workspaceId:d,role:"owner",email:x.email,name:x.name}),h=o.NextResponse.json({success:!0,data:{id:x._id,name:x.name,email:x.email,role:"owner"}});return h.cookies.set(await (0,f.Zk)(),v,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:604800}),h.cookies.set(await (0,f.KF)(),d,{httpOnly:!0,sameSite:"lax",path:"/",secure:!0,maxAge:2592e3}),h}let x=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/signup/route",pathname:"/api/auth/signup",filename:"route",bundlePath:"app/api/auth/signup/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\auth\\signup\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:v,staticGenerationAsyncStorage:h,serverHooks:A}=x,q="/api/auth/signup/route";function _(){return(0,s.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:h})}},73275:(e,t,r)=>{r.d(t,{KF:()=>A,MH:()=>k,XC:()=>v,Zk:()=>h,hg:()=>x,kt:()=>f,oT:()=>I,ts:()=>S,v6:()=>y});var n=r(52845),i=r(67370),a=r(32914),s=r(63253),o=r(82279),d=r(46993),l=r(48948);let u="vaultflow_session",c="vaultflow_workspace";function p(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function w(e){return"owner"===e.toLowerCase()?"owner":"editor"}function m(e,t){if(!e)return"";for(let r of e.split(";").map(e=>e.trim()))if(r.startsWith(`${t}=`))return decodeURIComponent(r.slice(`${t}=`.length));return""}async function g(e,t,r){await (0,l.C)();let n=await s.T.findById(e).lean();if(!n||!n.isActive)return null;let i=r||t||n.workspaceId;if(i===n.workspaceId)return{workspaceId:i,role:w(n.role),email:n.email,name:n.name};let a=await d.N.findOne({userId:e,workspaceId:i,isActive:!0}).lean();return a?{workspaceId:i,role:"owner"===a.role?"owner":"editor",email:n.email,name:n.name}:{workspaceId:n.workspaceId,role:w(n.role),email:n.email,name:n.name}}async function f(e){let t=Math.floor(Date.now()/1e3);return new i.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(p())}async function y(e){try{let t=e.headers.get("cookie"),r=m(t,u);if(!r)return null;let{payload:n}=await (0,a._)(r,p()),i="string"==typeof n.userId?n.userId:"",s="string"==typeof n.workspaceId?n.workspaceId:"",o=m(t,c);if(!i)return null;let d=await g(i,s,o);if(!d)return null;return{userId:i,workspaceId:d.workspaceId,role:d.role,email:d.email,name:d.name}}catch{return null}}async function I(e){let t=await y(e);if(!t)throw Error("Unauthorized");return t}async function k(e,t){let r=await I(e),n="owner"===t.toLowerCase()?"owner":"editor";if(r.role!==n)throw Error("Forbidden");return r}async function S(){let e=(0,n.cookies)(),t=e.get(u)?.value;if(!t)return null;try{let{payload:r}=await (0,a._)(t,p()),n="string"==typeof r.userId?r.userId:"",i="string"==typeof r.workspaceId?r.workspaceId:"",o=e.get(c)?.value??"";if(!n)return null;let d=await g(n,i,o);if(!d)return null;let l=await s.T.findById(n).lean();if(!l||!l.isActive)return null;return{id:String(l._id),workspaceId:d.workspaceId,name:l.name,email:l.email,role:d.role,avatarUrl:l.avatarUrl??""}}catch{return null}}async function x(){let e=await S();if(!e)return[];await (0,l.C)();let t=await s.T.findById(e.id).lean();if(!t)return[];let r=await d.N.find({userId:e.id,isActive:!0}).lean(),n=Array.from(new Set([String(t.workspaceId),...r.map(e=>String(e.workspaceId))])),i=await o.u.find({_id:{$in:n},isActive:!0}).lean();if(!i.some(e=>String(e._id)===String(t.workspaceId))){let e=await o.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&i.push(e)}return n.map(n=>{let a=i.find(e=>String(e._id)===n),s=r.find(e=>String(e.workspaceId)===n),o=n===String(t.workspaceId)?"owner":s?.role==="owner"?"owner":"editor";return{id:n,name:a?.name??(n===String(t.workspaceId)?"My Workspace":`Workspace ${n.slice(0,6)}`),logoUrl:a?.logoUrl??"",role:o,isPersonal:n===String(t.workspaceId),isActive:n===e.workspaceId}})}async function v(){let e=await S();return e?.role??null}async function h(){return u}async function A(){return c}},48948:(e,t,r)=>{r.d(t,{C:()=>o});var n=r(11185),i=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("MONGODB_URI is not defined");let s=global.mongoose??{conn:null,promise:null};async function o(){return s.conn||(s.promise||(s.promise=i().connect(a).then(e=>e)),s.conn=await s.promise,global.mongoose=s),s.conn}},79551:(e,t,r)=>{r.d(t,{u:()=>s});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},actorId:{type:String},actorRole:{type:String},actorEmail:{type:String},action:{type:String,required:!0},entityType:{type:String},entityId:{type:String},meta:{type:String},createdAt:{type:String,required:!0}},{timestamps:!1}),s=i().models.Audit||i().model("Audit",a)},45018:(e,t,r)=>{r.d(t,{q:()=>s});var n=r(11185),i=r.n(n);let a=new n.Schema({email:{type:String,required:!0,lowercase:!0,index:!0},name:{type:String,default:""},role:{type:String,enum:["Owner","Editor"],required:!0},token:{type:String,required:!0,unique:!0,index:!0},status:{type:String,enum:["pending","accepted","revoked","expired"],default:"pending",index:!0},invitedById:{type:String,required:!0},invitedByEmail:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},expiresAt:{type:Date,required:!0,index:!0},acceptedAt:{type:Date},acceptedUserId:{type:String}},{timestamps:!0});a.index({workspaceId:1,email:1,status:1}),a.index({workspaceId:1,createdAt:-1});let s=i().models.TeamInvite||i().model("TeamInvite",a)},63253:(e,t,r)=>{r.d(t,{T:()=>s});var n=r(11185),i=r.n(n);let a=new n.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});a.index({email:1},{unique:!0}),a.index({workspaceId:1,role:1}),a.index({workspaceId:1,isActive:1});let s=i().models.User||i().model("User",a)},82279:(e,t,r)=>{r.d(t,{u:()=>s});var n=r(11185),i=r.n(n);let a=new n.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),s=i().models.Workspace||i().model("Workspace",a)},46993:(e,t,r)=>{r.d(t,{N:()=>s});var n=r(11185),i=r.n(n);let a=new n.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});a.index({workspaceId:1,userId:1},{unique:!0}),a.index({userId:1,isActive:1});let s=i().models.WorkspaceMembership||i().model("WorkspaceMembership",a)},13634:(e,t,r)=>{r.d(t,{G:()=>s,c:()=>a});var n=r(63506),i=r.n(n);async function a(e){let t=await i().genSalt(10);return i().hash(e,t)}async function s(e,t){return i().compare(e,t)}},940:(e,t,r)=>{r.d(t,{h:()=>i,r:()=>a});let n=new Map;function i(e){let t=Date.now();n.size>1e4&&function(e){for(let[t,r]of n)r.resetAt<=e&&n.delete(t)}(t);let r=n.get(e.key);return!r||r.resetAt<=t?(n.set(e.key,{count:1,resetAt:t+e.windowMs}),{ok:!0,remaining:Math.max(0,e.limit-1),retryAfterMs:0}):r.count>=e.limit?{ok:!1,remaining:0,retryAfterMs:Math.max(0,r.resetAt-t)}:(r.count+=1,n.set(e.key,r),{ok:!0,remaining:Math.max(0,e.limit-r.count),retryAfterMs:0})}function a(e){let t=e.headers.get("x-forwarded-for");if(t){let e=t.split(",")[0]?.trim();if(e)return e}return e.headers.get("x-real-ip")??"unknown"}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9379,6936,2960,4833,9977,3506],()=>r(1412));module.exports=n})();