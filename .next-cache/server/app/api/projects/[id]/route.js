"use strict";(()=>{var e={};e.id=7361,e.ids=[7361],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},40518:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>k,patchFetch:()=>h,requestAsyncStorage:()=>_,routeModule:()=>g,serverHooks:()=>Z,staticGenerationAsyncStorage:()=>I});var r={};n.r(r),n.d(r,{DELETE:()=>f,GET:()=>w,PATCH:()=>y});var o=n(73278),i=n(45002),a=n(54877),s=n(71309),l=n(48948),d=n(65278),p=n(88483),c=n(73275),u=n(93133);function m(e){let{_id:t,__v:n,links:r,attachments:o,...i}=e.toObject?e.toObject():e,a=Array.isArray(r)?r:r?Object.values(r).filter(Boolean):[],s=Array.isArray(o)?o.map(e=>"string"==typeof e?{id:void 0,name:e.split("/").filter(Boolean).pop()??"Attachment",url:e,type:"",size:0}:e).filter(Boolean):[];return{id:t,...i,links:a,attachments:s}}async function w(e,{params:t}){let n;try{n=await (0,c.oT)(e)}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}await (0,l.C)();let r=await d.X.findOne({_id:t.id,workspaceId:n.workspaceId});if(!r)return s.NextResponse.json({success:!1,error:"Not found"},{status:404});let o=m(r);return s.NextResponse.json({success:!0,data:(0,u.Jr)(o,n.role)})}async function y(e,{params:t}){let n,r;try{n=await (0,c.oT)(e)}catch{return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401})}await (0,l.C)();let o=await e.json(),i=p.CB.safeParse(o);if(!i.success)return s.NextResponse.json({success:!1,error:i.error.flatten()},{status:400});try{(0,u.Ak)(i.data,n.role)}catch(e){return s.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Forbidden"},{status:400})}let{removeAttachmentUrls:a,...w}=i.data,y=w.contactId?{...w,clientName:void 0}:w;r=a&&a.length>0?{...Object.keys(y).length>0?{$set:y}:{},$pull:{attachments:{url:{$in:a}}}}:y;let f=await d.X.findOneAndUpdate({_id:t.id,workspaceId:n.workspaceId},r,{new:!0});if(!f)return s.NextResponse.json({success:!1,error:"Not found"},{status:404});let g=m(f);return s.NextResponse.json({success:!0,data:(0,u.Jr)(g,n.role)})}async function f(e,{params:t}){let n;try{n=await (0,c.MH)(e,"Owner")}catch{return s.NextResponse.json({success:!1,error:"Forbidden"},{status:403})}return(await (0,l.C)(),await d.X.findOneAndDelete({_id:t.id,workspaceId:n.workspaceId}))?s.NextResponse.json({success:!0,data:{id:t.id}}):s.NextResponse.json({success:!1,error:"Not found"},{status:404})}let g=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/projects/[id]/route",pathname:"/api/projects/[id]",filename:"route",bundlePath:"app/api/projects/[id]/route"},resolvedPagePath:"F:\\Coding\\Flowlane\\src\\app\\api\\projects\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:I,serverHooks:Z}=g,k="/api/projects/[id]/route";function h(){return(0,a.patchFetch)({serverHooks:Z,staticGenerationAsyncStorage:I})}},73275:(e,t,n)=>{n.d(t,{KF:()=>v,MH:()=>I,XC:()=>h,Zk:()=>S,hg:()=>k,kt:()=>f,oT:()=>_,ts:()=>Z,v6:()=>g});var r=n(52845),o=n(67370),i=n(32914),a=n(63253),s=n(82279),l=n(46993),d=n(48948);let p="vaultflow_session",c="vaultflow_workspace";function u(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET is not defined");return new TextEncoder().encode(e)}function m(e){return"owner"===e.toLowerCase()?"owner":"editor"}function w(e,t){if(!e)return"";for(let n of e.split(";").map(e=>e.trim()))if(n.startsWith(`${t}=`))return decodeURIComponent(n.slice(`${t}=`.length));return""}async function y(e,t,n){await (0,d.C)();let r=await a.T.findById(e).lean();if(!r||!r.isActive)return null;let o=n||t||r.workspaceId;if(o===r.workspaceId)return{workspaceId:o,role:m(r.role),email:r.email,name:r.name};let i=await l.N.findOne({userId:e,workspaceId:o,isActive:!0}).lean();return i?{workspaceId:o,role:"owner"===i.role?"owner":"editor",email:r.email,name:r.name}:{workspaceId:r.workspaceId,role:m(r.role),email:r.email,name:r.name}}async function f(e){let t=Math.floor(Date.now()/1e3);return new o.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt(t).setExpirationTime(t+604800).sign(u())}async function g(e){try{let t=e.headers.get("cookie"),n=w(t,p);if(!n)return null;let{payload:r}=await (0,i._)(n,u()),o="string"==typeof r.userId?r.userId:"",a="string"==typeof r.workspaceId?r.workspaceId:"",s=w(t,c);if(!o)return null;let l=await y(o,a,s);if(!l)return null;return{userId:o,workspaceId:l.workspaceId,role:l.role,email:l.email,name:l.name}}catch{return null}}async function _(e){let t=await g(e);if(!t)throw Error("Unauthorized");return t}async function I(e,t){let n=await _(e),r="owner"===t.toLowerCase()?"owner":"editor";if(n.role!==r)throw Error("Forbidden");return n}async function Z(){let e=(0,r.cookies)(),t=e.get(p)?.value;if(!t)return null;try{let{payload:n}=await (0,i._)(t,u()),r="string"==typeof n.userId?n.userId:"",o="string"==typeof n.workspaceId?n.workspaceId:"",s=e.get(c)?.value??"";if(!r)return null;let l=await y(r,o,s);if(!l)return null;let d=await a.T.findById(r).lean();if(!d||!d.isActive)return null;return{id:String(d._id),workspaceId:l.workspaceId,name:d.name,email:d.email,role:l.role,avatarUrl:d.avatarUrl??""}}catch{return null}}async function k(){let e=await Z();if(!e)return[];await (0,d.C)();let t=await a.T.findById(e.id).lean();if(!t)return[];let n=await l.N.find({userId:e.id,isActive:!0}).lean(),r=Array.from(new Set([String(t.workspaceId),...n.map(e=>String(e.workspaceId))])),o=await s.u.find({_id:{$in:r},isActive:!0}).lean();if(!o.some(e=>String(e._id)===String(t.workspaceId))){let e=await s.u.findOneAndUpdate({_id:String(t.workspaceId)},{_id:String(t.workspaceId),name:`${t.name}'s Workspace`,ownerUserId:String(t._id),isActive:!0},{upsert:!0,new:!0,setDefaultsOnInsert:!0}).lean();e&&o.push(e)}return r.map(r=>{let i=o.find(e=>String(e._id)===r),a=n.find(e=>String(e.workspaceId)===r),s=r===String(t.workspaceId)?"owner":a?.role==="owner"?"owner":"editor";return{id:r,name:i?.name??(r===String(t.workspaceId)?"My Workspace":`Workspace ${r.slice(0,6)}`),logoUrl:i?.logoUrl??"",role:s,isPersonal:r===String(t.workspaceId),isActive:r===e.workspaceId}})}async function h(){let e=await Z();return e?.role??null}async function S(){return p}async function v(){return c}},48948:(e,t,n)=>{n.d(t,{C:()=>s});var r=n(11185),o=n.n(r);let i=process.env.MONGODB_URI;if(!i)throw Error("MONGODB_URI is not defined");let a=global.mongoose??{conn:null,promise:null};async function s(){return a.conn||(a.promise||(a.promise=o().connect(i).then(e=>e)),a.conn=await a.promise,global.mongoose=a),a.conn}},65278:(e,t,n)=>{n.d(t,{X:()=>s});var r=n(11185),o=n.n(r);let i=new r.Schema({id:String,name:String,url:String,type:String,size:Number},{_id:!1}),a=new r.Schema({_id:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},contactId:{type:String,required:!1,default:void 0},clientName:{type:String},title:{type:String,required:!0},name:{type:String},status:{type:String,default:"planning"},pipelineStage:{type:String},notes:{type:String},attachments:{type:[i],default:[]},startDate:{type:String},dueDate:{type:String},budgetAmount:{type:Number,default:0},currency:{type:String,default:"USD"},links:{type:[String],default:[]},archived:{type:Boolean,default:!1}},{timestamps:!0});a.index({workspaceId:1,status:1,archived:1}),a.index({workspaceId:1,contactId:1}),a.index({workspaceId:1,dueDate:1}),a.index({workspaceId:1,updatedAt:-1}),o().models.Project&&o().deleteModel("Project");let s=o().models.Project||o().model("Project",a)},63253:(e,t,n)=>{n.d(t,{T:()=>a});var r=n(11185),o=n.n(r);let i=new r.Schema({email:{type:String,required:!0,lowercase:!0},name:{type:String,required:!0},role:{type:String,enum:["Owner","Editor"],required:!0},passwordHash:{type:String,required:!0},workspaceId:{type:String,required:!0,index:!0,default:"default"},isActive:{type:Boolean,default:!0},invoiceEmailTemplate:{type:String,default:""},avatarUrl:{type:String,default:""}},{timestamps:!0});i.index({email:1},{unique:!0}),i.index({workspaceId:1,role:1}),i.index({workspaceId:1,isActive:1});let a=o().models.User||o().model("User",i)},82279:(e,t,n)=>{n.d(t,{u:()=>a});var r=n(11185),o=n.n(r);let i=new r.Schema({_id:{type:String,required:!0},name:{type:String,required:!0},logoUrl:{type:String,default:""},ownerUserId:{type:String,required:!0},isActive:{type:Boolean,default:!0}},{timestamps:!0}),a=o().models.Workspace||o().model("Workspace",i)},46993:(e,t,n)=>{n.d(t,{N:()=>a});var r=n(11185),o=n.n(r);let i=new r.Schema({userId:{type:String,required:!0,index:!0},workspaceId:{type:String,required:!0,index:!0},role:{type:String,enum:["owner","editor"],required:!0},isActive:{type:Boolean,default:!0},invitedById:{type:String,default:""}},{timestamps:!0});i.index({workspaceId:1,userId:1},{unique:!0}),i.index({userId:1,isActive:1});let a=o().models.WorkspaceMembership||o().model("WorkspaceMembership",i)},93133:(e,t,n)=>{function r(e,t){if("owner"===t)return e;let{amount:n,currency:r,paidDate:o,lineItems:i,payments:a,...s}=e;return s}function o(e,t){if("owner"!==t&&["amount","currency","paidDate","lineItems","payments","status"].some(t=>t in e))throw Error("Editor cannot modify finance fields.")}function i(e,t){if("owner"===t)return e;let{budgetAmount:n,currency:r,...o}=e;return o}function a(e,t){if("owner"!==t&&["budgetAmount","currency","budget"].some(t=>t in e))throw Error("Editor cannot modify budget fields.")}n.d(t,{Ak:()=>a,Jr:()=>i,KL:()=>o,xr:()=>r})},88483:(e,t,n)=>{n.d(t,{CB:()=>s,CP:()=>f,IK:()=>m,Im:()=>l,It:()=>w,JE:()=>d,K9:()=>c,Ov:()=>u,Qm:()=>i,Qp:()=>_,VJ:()=>o,X5:()=>I,cM:()=>y,jt:()=>p,nf:()=>g,rP:()=>a});var r=n(69977);let o=r.Ryn({name:r.Z_8().min(1),email:r.Z_8().email().optional().or(r.i0J("")),phone:r.Z_8().optional().or(r.i0J("")),company:r.Z_8().optional().or(r.i0J("")),source:r.Z_8().optional(),sourceLabel:r.Z_8().optional(),stage:r.Z_8().optional(),nextFollowUpAt:r.Z_8().optional(),followUpCadence:r.KmV(["none","weekly","monthly","custom"]).optional(),followUpIntervalDays:r.Rxh().optional(),tags:r.IXX(r.Z_8()).optional(),notes:r.IXX(r.Ryn({id:r.Z_8(),body:r.Z_8(),createdAt:r.Z_8()})).optional(),archived:r.O72().optional()}),i=o.partial(),a=r.Ryn({title:r.Z_8().min(1),name:r.Z_8().optional(),contactId:r.Z_8().min(1).optional(),clientName:r.Z_8().optional(),status:r.Z_8().optional(),pipelineStage:r.Z_8().optional(),notes:r.Z_8().optional(),attachments:r.IXX(r.Ryn({id:r.Z_8().optional(),name:r.Z_8().min(1),url:r.Z_8().min(1),type:r.Z_8().optional().default(""),size:r.Rxh().nonnegative()})).optional(),startDate:r.Z_8().optional(),dueDate:r.Z_8().optional(),budgetAmount:r.Rxh().optional(),currency:r.Z_8().optional(),links:r.IXX(r.Z_8().url()).optional(),archived:r.O72().optional()}),s=a.partial().extend({removeAttachmentUrls:r.IXX(r.Z_8().min(1)).optional()}),l=r.Ryn({invoiceNo:r.Z_8().min(1),projectId:r.Z_8().min(1),contactId:r.Z_8().min(1),status:r.Z_8().optional(),issueDate:r.Z_8().optional(),dueDate:r.Z_8().optional(),paidDate:r.Z_8().optional(),amount:r.Rxh().optional(),currency:r.Z_8().optional(),lineItems:r.IXX(r.Ryn({title:r.Z_8(),qty:r.Rxh(),rate:r.Rxh()})).optional(),payments:r.IXX(r.Ryn({amount:r.Rxh(),method:r.Z_8(),paidAt:r.Z_8(),note:r.Z_8().optional()})).optional(),archived:r.O72().optional()}),d=l.partial(),p=r.Ryn({entityType:r.KmV(["contact","project","invoice","milestone"]),entityId:r.Z_8().min(1),action:r.Z_8().min(1),message:r.Z_8().optional(),userRole:r.Z_8().optional()}),c=p.partial(),u=r.Ryn({projectId:r.Z_8().min(1),title:r.Z_8().min(1),status:r.Z_8().optional(),dueDate:r.Z_8().optional(),amount:r.Rxh().optional(),currency:r.Z_8().optional(),order:r.Rxh().optional()}),m=u.partial(),w=r.Ryn({action:r.Z_8().min(1),entityType:r.Z_8().optional(),entityId:r.Z_8().optional(),meta:r.Z_8().optional()}),y=r.Ryn({name:r.Z_8().min(1),email:r.Z_8().email(),role:r.KmV(["Owner","Editor"]),password:r.Z_8().min(8)}),f=r.Ryn({name:r.Z_8().min(1).optional(),role:r.KmV(["Owner","Editor"]).optional(),isActive:r.O72().optional(),password:r.Z_8().min(8).optional()}),g=r.Ryn({orgName:r.Z_8().min(1),timezone:r.Z_8().min(1),logoUrl:r.Z_8().optional()}),_=r.Ryn({name:r.Z_8().min(1).optional(),avatarUrl:r.Z_8().min(1).optional().or(r.i0J(""))}),I=r.Ryn({email:r.Z_8().email(),name:r.Z_8().optional().or(r.i0J("")),role:r.KmV(["Owner","Editor"])});r.Ryn({status:r.KmV(["revoked"]).optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9379,6936,2960,4833,9977],()=>n(40518));module.exports=r})();